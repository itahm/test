<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title></title>
		
		<style>
body {
	font-family: tahoma, arial, "맑은 고딕";
	margin: 0;
	padding: 0; 
}

li, input, button, td {
	font-size: 14px;
}

header {
	position: fixed; top: 0; right: 0; left: 0; height: 40px;
	line-height: 30px;
	padding: 5px;
	box-sizing: border-box;
	font-size: 12px;
	background-color: #0084ff;
}

.loading {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	background: rgba(255, 255, 255, .8) url("img/waiting.gif") no-repeat center;
}

div[role="main"] {
	position: fixed; top: 40px; right: 0; left: 0; bottom: 0;
}

div[role="main"].setting {
	padding: 10px;
	background-color: rgba(255, 255, 255, 1);
}

div[role="main"].setting input {
	padding: 10px;
	box-sizing: border-box;
}

iframe {
	width: 100%; height: 100%;
	margin: 0;
	padding: 0;
	border: 0;
}

.iframe {
	position: absolute; width: 50%; height: 50%;
}

body.maximized .iframe {
	width: 100%;
	height: 100%;
}

.iframe.tl {
	top: 0; left: 0;
}

.iframe.tr {
	top: 0; right: 0;
}

.iframe.bl {
	bottom: 0; left: 0;
}

.iframe.br {
	bottom: 0; right: 0;
}

#profile li div:nth-child(1):before {
	content: "community string";
	width : 150px;
	display: inline-block;
}

#profile li div:nth-child(2):before {
	content: "snmp version";
	width : 150px;
	display: inline-block;
}

#profile li div:nth-child(3):before {
	content: "udp port";
	width : 150px;
	display: inline-block;
}

#toolbar {
	position: absolute; top: 0; right: 0;
}

button, input[type="button"] {
	margin-left: 20px;
	vertical-align: middle;
	padding: .5em;
}

header img,
#toolbar img {
	vertical-align: middle;
	border: 1px solid transparent;
}

header img:hover,
#toolbar img:hover {
	border-color: #ddf;
	cursor: pointer;
}

#dialog:not(:empty) {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	display: flex;
	flex-direction:row;
	justify-content: center;
	align-items: center;
	background-color: rgba(255, 255, 255, .8);
}

#dialog>form {
	padding: 20px;
	background-color: #fff;
	box-shadow: 0px 0px 20px 10px #ddd;
}

#dialog input,
#dialog select {
	padding: .5em;
}

#dialog select {
	box-sizing: border-box;
	width: 100%;
}

.flex {
	display: flex;
}


.flex input {
	flex: 1;
}

#dialog,
#view {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(255, 255, 255, .8);
	border: 0;
	margin: 0;
	padding: 0;
}

#view {
	background-color: #fff;
}

body.maximized #maximize,
body.connected #form_agent,
body.setting>:not(header):not(.setting),
body:not(.maximized) #minimize,
body:not(.setting)>.setting,
body:not(.connected) .connected,
body:not(.authorized) .authorized,
body:not(.loading) .loading, 
.hide {
	display: none;
}


		</style>
		
	</head>
	
	<body>
	
		<header>
			<img src="img/gear_w.png" id="setting">
			<img src="img/synchronize_w.png">
		</header>
		
		<div role="main">
			<section class="iframe tl">
				<iframe id="frame_list"></iframe>
			</section>
			
			<section class="iframe tr">
				<iframe id="frame_map"></iframe>
			</section>
			
			<section class="iframe bl">
				<iframe id="frame_device"></iframe>
			</section>
			
			<section class="iframe br">
				<iframe id="frame_event"></iframe>
			</section>
		</div>
		
		<div class="loading"></div>
		
		<iframe id="view" src="view/setting.html"></iframe>
		
		<iframe id="dialog" class="hide"></iframe>
		
		<div class="hide">
			<div id="toolbar" class="minimized">
				<img id="maximize" src="img/maximize.png">
				<img id="minimize" src="img/minimize.png">
			</div>
			
			<iframe id="frame_icon"></iframe>
			
			
			
			<form id="device_dialog">
				<h2>device</h2>
				<table>
					<tbody>
						<tr>
							<td>name</td>
							<td>
								<input type="text" name="name" placeholder="device name" required autofocus>
							</td>
						</tr>
						<tr>
							<td>ip address</td>
							<td>
								<input type="text" name="ip" title="valid ip v4 address required" placeholder="device ip address"
									pattern="((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)" required>
							</td>
						</tr>
						<tr>
							<td>type</td>
							<td>
								<select name="type"></select>
							</td>
						</tr>
						<tr>
							<td>label</td>
							<td>
								<input type="text" name="label">
							</td>
						</tr>
						<tr>
							<td>snmp profile</td>
							<td>
								<select name="profile"></select>
							</td>
						</tr>
					</tbody>
				</table>
				<div class="flex">
					<input type="reset" value="cancel">
					<input type="submit" value="apply">
				</div>
			</form>
			
		</div>
		
		<script src="js/icon.js"></script>
		<script src="js/Communicator.js"></script>
		<script>

var elements = {
		dialog: document.getElementById("dialog"),
		fragment: document.getElementById("fragment"),
		frame: {
			list: document.getElementById("frame_list"),
			map : document.getElementById("frame_map"),
			device: document.getElementById("frame_device")
		},
		toolbar: document.getElementById("toolbar"),
		maximize: document.getElementById("maximize"),
		minimize: document.getElementById("minimize"),
		setting: document.getElementById("setting")
	};

/**
 * 공통
 */
(function (window, undefined){
	var agent;
	
	// event 등록
	elements.setting.addEventListener("click", onSetting, false);
	elements.maximize.addEventListener("click", onMaximize, false);
	elements.minimize.addEventListener("click", onMinimize, false);
	
	// 각 frame들에게 event 등록
	(function (frame) {
		for (var id in frame) {
			frame[id].addEventListener("mouseenter", onFocus, false);
		}
		
	}) (elements.frame);
	
	/**
	 * load
	 * agent가 결정되고 signin 하면 호출된다.
	 * deviceData, iconData 초기화
	 */
	function load() {
		document.body.classList.add("authorized");
		document.body.classList.remove("setting");
		
		initAccount();
		initProfile();
		initDevice();
		initIcon();
	}
	
	/**
	 * callback method
	 */
		
		
	function onSetting(e) {
		showView("view/setting.html");
		//document.body.classList.toggle("setting");
	}
	
	function onMaximize(e) {
		maximize(this.parentNode.parentNode);
	}
	
	function onMinimize(e) {
		minimize();
	}
	
	function onFocus() {
		var selected = this.parentNode;
		
		selected.appendChild(elements.toolbar);
	}
	
	function onAddAccount (e) {
		e.preventDefault();
	}
	
	function onRemoveAccount (e) {
		e.preventDefault();
	}	
	
	/**
	 * private method
	 */
	
	function maximize(frame) {
		for (var id in elements.frame) {
			elements.frame[id].parentNode.classList.add("hide");
		}
		
		frame.classList.remove("hide");
		
		document.body.classList.add("maximized");
	}
	
	function minimize() {
		var frame = elements.frame;
		
		for (var id in frame) {
			frame[id].parentNode.classList.remove("hide");
		}
		
		document.body.classList.remove("maximized");
	}
	
	/**
	 * public method
	 */
	
	window.unauthorized = function () {
		var classList = document.body.classList;
		
		showView("view/setting.html");
	};
	
	window.selectDevice = function (id) {
		
		if (id) {
			elements.frame.map.contentWindow.selectDevice(id);
		}
		
		elements.frame.device.contentWindow.resetDevice(id);
	};
	
	window.minimize = function () {
		if (document.body.classList.contains("maximized")) {
			minimize();
		}
	};
	
	window.getFrame = function (frameName) {
		return elements.frame[frameName].contentWindow;
	};
	
	window.reload = function () {
		location.reload();
	};
	
	window.refresh = function () {
		
	};
	
	window.authorized = function (address) {
		// 여기에서 초기화
		initAccount();
		initProfile();
		initDevice();
		initIcon();
	};
	
	window.getAgent = function () {
		return agent;
	};
	
	window.tryEcho = function (address, onecho) {console.log(address);
		var communicator = new Communicator();
		
		agent = address;
		
		address = address.split(":");
		communicator.connect(address[0], address[1]);
		
		communicator.send({
			command: "echo"
		}, onecho);
		
		window.sendRequest = communicator.send;
	}
	
}) (window);




// icon 관리
(function (window, undefined) {
	var iconData = {},
		customData = {},
		types = [],
		index;
	/*
	function loadIcon() {
		var img = customData[types[index]],
			icon = new Image();
		
		icon.setAttribute("id", img.id);
		icon.setAttribute("class", img.group);
		icon.setAttribute("alt", img.alt);
		icon.setAttribute("src", img.src);
		icon.onload = onLoadIcon;
	}
	
	// callback
	
	// img.onload
	function onLoadIcon() {
		var icon = this;
		
		iconData[icon.id] = icon;
		
		if (++index < types.length) {
			loadIcon()
		}
		else {
			onIconLoaded(iconData);
		}
		
	}
	*/
	// frame.onload
	function onLoadFrame() {
		var images = this.contentWindow.document.getElementsByTagName("img"),
			icon;
		
		for (var i=0, length=images.length; i<length; i++) {
			icon = images[i];
			
			iconData[icon.getAttribute("id")] = icon;
		}
		
		// 모든 frame load
		var frame;
		for (var name in elements.frame) {
			frame = elements.frame[name];
			frame.src = name+".html";
			frame.contentWindow.addEventListener("load", onFrameLoad, false);
		}
	}
	
	function onResponse(data, status) {
		if (status === 200) {
			customData = data;
			
			var frame = document.getElementById("frame_icon");
			
			frame.onload = onLoadFrame;
			frame.src = "icon.html";
		}
		else if (status === 401) {
			unauthorized();
		}
		else {
			throw "";
		}
	}
	
	window.initIcon = function () {
		sendRequest({
			command: "pull",
			database: "icon"
		}, onResponse, true);
	};
	
	window.getCustomIconData = function () {
		return customData;
	};
	
	window.getIconData = function () {
		return iconData;
	};
	
}) (window);

//device 관리
(function (window, undefined) {
	var dialog = document.getElementById("device_dialog"),
		deviceData,
		selectedDevice,
		tmpID = -1,
		applyDevice;
	
	// 적용
	dialog.addEventListener("submit", function (e) {
		e.preventDefault();
		
		applyDevice();		
	}, false);
	
	// 취소
	dialog.addEventListener("reset", function (e) {
		elements.dialog.removeChild(dialog);
	}, false);
	
	// private method
	
	// callback
	function onResponse(data, status) {
		if (status != 200) {
			return;
		}
		
		deviceData = data;
		
		// profile data가 반드시 존재 해야함
		var profileData = getProfileData();
	}
	
	function onApply(id) {
		deviceData[id] = {
			name: dialog.elements.name.value,
			ip: dialog.elements.ip.value,
			type: dialog.elements.type.value,
			label: dialog.elements.label.value,
			profile: dialog.elements.profile.value
		};
		
		dialog.reset();
	}
	
	window.onFrameLoad = function () {
		if (this.id === "frame_device") {
			console.log("success");
		} 
	}
	
	window.getDeviceData = function () {
		return deviceData;
	};
	
	window.addDevice = function () {
		applyDevice = onApply.bind(undefined, tmpID--);
		
		elements.dialog.appendChild(dialog);
		
		dialog.elements.name.focus();
	};
	
	window.addDevice = function () {
		selectedDevice = undefined;
		
		showDialog("dialog/device.html");
	};
	
	window.createDevice = function (device) {
		var id = tmpID--;
		
		device.id = id;
		device.x = 0;
		device.y = 0;
		
		deviceData[id] = device;
	}
	
	window._editDevice = function (id) {
		var device = deviceData[id];
		
		applyDevice = onApply.bind(undefined, id);
		
		elements.dialog.appendChild(dialog);
		
		dialog.elements.name.value = device.name;
		dialog.elements.ip.value = device.ip;
		dialog.elements.type.value = device.type;
		dialog.elements.label.value = device.label && (device.label.split(",")).join(", ") || "";
		dialog.elements.profile.value = device.profile;
		
		dialog.elements.name.select();
	};
	
	window.editDevice = function (id) {
		selectedDevice = deviceData[id];
		
		showDialog("dialog/device.html");
	}
	
	window.removeDevice = function (idList) {
		for (var i=0, length=idList.length; i<length; i++) {
			delete deviceData[idList[i]];
		}
	};
	
	window.initDevice = function () {
		sendRequest({
			command: "pull",
			database: "device"
		}, onResponse);
	};
	
	window.getSelectedDevice = function () {
		return selectedDevice;
	};
	
}) (window);


/**
 * account
 */
(function (window, undefined) {
	var accountData,
		selectedAccount;
	
	function onResponse(data, status) {
		if (status != 200) {
			return;
		}
		
		accountData = data;
	}
	
	window.initAccount = function () {
		sendRequest({
			command: "pull",
			database: "account"
		}, onResponse);
	};
	
	window.getAccountData = function () {
		return accountData;
	};
	
	window.getSelectedAccount = function (profile) {
		return selectedAccount;
	};
	
	window.selectAccount = function (account) {
		selectedAccount = account;

		showDialog("../dialog/account.html");
	};
	
}) (window);

/**
 * profile
 */
(function (window, undefined) {
	var profileData,
		selectedProfile;
	
	function onResponse(data, status) {
		if (status != 200) {
			return;
		}
		
		profileData = data;
	}
	
	window.initProfile = function () {
		sendRequest({
			command: "pull",
			database: "profile"
		}, onResponse);
	};
	
	window.getProfileData = function () {
		return profileData;
	};
	
	window.getSelectedProfile = function (profile) {
		return selectedProfile;
	};
	
	window.selectProfile = function (profile) {
		selectedProfile = profile;
			
		showDialog("../dialog/profile.html");
	};
	
}) (window);

/**
 * view
 */
(function (window, undefined) {
	var view = document.getElementById("view");
	
	function showView() {
		view.classList.remove("hide");
	}
	
	view.onload = showView;
	
	window.showView = function (url) {
		view.src = url;
	};
	
	window.closeView = function () {
		view.classList.add("hide");
	};
	
}) (window);

/**
 * dialog
 */
(function (window, undefined) {
	var dialog = document.getElementById("dialog");
	
	function showDialog() {
		dialog.classList.remove("hide");
	}
	
	dialog.onload = showDialog;
	
	window.showDialog = function (url) {
		dialog.src = url;
	};
	
	window.closeDialog = function () {
		dialog.classList.add("hide");
	};
	
}) (window);

		</script>
	
	</body>
	
</html>