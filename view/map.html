<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Insert title here</title>

		<style>
svg {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
}

image {
	fill: #f00;
}

#line line {
	stroke: #0f0;
	stroke-width: 2;
}

#link line {
	stroke: #800;
	stroke-width: 2;
}

text {
	font-family: tahoma, arial, "맑은 고딕";
	font-size: 10px;
	fill: #000;
	text-anchor: middle;
}

#if_name text {
	fill: #777;
}

#device text {
	font-size: 12px;
	alignment-baseline: hanging;
	fill: #000;
}

#select circle {
	stroke: #fdd400;
	stroke-width: 2px;
	fill: #ff0;
}

#select g:hover {
	cursor: pointer;
}

#link circle {
	stroke: #800;
	stroke-width: 1px;
	fill: #f00;
}

iframe {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
	border: none;
	margin: 0;
	padding: 0;
	background-color: rgba(255, 255, 255, .9);
}

iframe[src="about:blank"] {
	display: none;
}

		</style>
	</head>

	<body>
		<svg id="stage">
			<g id="transform" transform="translate(0, 0) translate(0, 0) translate(0, 0) scale(1, 1)">
				<g id="line"></g>
				<g id="if_name"></g>
				<g id="select">
					<g id="selected"></g>
				</g>
				<g id="link"></g>
				<g id="device"></g>
			</g>
		</svg>
		
		<iframe id="dialog" src="about:blank"></iframe>
	<script src="../js/Draggable.js"></script>
	<script>

if (!opener) throw "";

var svgNS = "http://www.w3.org/2000/svg",
		xlinkNS = "http://www.w3.org/1999/xlink";

/**
 * dialog
 */
(function (window, undefined) {
	
	var dialog = document.getElementById("dialog");
	
	window.showDialog = function () {
		dialog.src = "../dialog/link.html";
	};
	
	window.closeDialog = function () {
		dialog.src = "about:blank";
	};
	
}) (window);

/**
 * stage
 */
(function (window, undefined) {
	var canvas = document.getElementById("stage"),
		base, translate, scale, ratio = 1,
		selectedDevice,
		destinationDevice,
		dragOrigin;

	function initialize() {		
		var transformList = document.getElementById("transform").transform.baseVal;
		
		new Draggable(canvas);
			
		base = transformList.getItem(0);
		translate = transformList.getItem(1);
		drag = transformList.getItem(2);
		scale = transformList.getItem(3);

		window.addEventListener("resize", function (e) {
			resetStage();
		});
		
		canvas.addEventListener("selectstart", function (e) {
			e.preventDefault();
		});
		
		canvas.addEventListener("wheel", function (e) {
			if (e.deltaY < 0) {
				//확대
				ratio *= 1.1;
			}
			else {
				//축소
				ratio /= 1.1;
			}
			
			scale.setScale(ratio, ratio);
		});
		
		canvas.addEventListener("click", onClick);
		
		canvas.addEventListener("dragstart", function (e) {
			var data = e.detail,
				target = data.target;
			
			// drag 발생시 select 취소
			canvas.addEventListener("click", cancelClick);
			canvas.removeEventListener("click", onClick);
			
			if (target.tagName === "image") {
				dragOrigin = {
					x: Number(target.getAttributeNS(null, "x")),
					y: Number(target.getAttributeNS(null, "y"))
				};
			}
			else if (target.tagName === "circle") {
				dragOrigin = {
					x: Number(target.getAttributeNS(null, "cx")),
					y: Number(target.getAttributeNS(null, "cy"))
				};
			}
		});
		
		canvas.addEventListener("dragmove", function (e) {
			var data = e.detail,
				target = data.target;

			// selectedDevice 인 경우 moveDevice
			if (target === selectedDevice) {
				moveDevice(selectedDevice, dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
				
				setSelectionMark(selectedDevice);
			}
			// linkToken 인 경우 moveLinkToken
			else if (isLinkToken(target)){
				var destination = data.destination;
				
				if (destination !== target && destination.tagName === "image") {
					moveLinkToken(Number(destination.getAttributeNS(null, "x")), Number(destination.getAttributeNS(null, "y")));
				}
				else {
					moveLinkToken(dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
				}
			}
			// 그렇지 않은 모든 경우 moveStage
			else {
				drag.setTranslate(data.dragX, data.dragY);
			}
		});
		
		canvas.addEventListener("dragend", function (e) {
			var data = e.detail,
				target = data.target,
				destination = data.destination;
			
			if (target === selectedDevice) {
			}
			else if (isLinkToken(target)){
				if (destination.tagName === "image") {
					destinationDevice = destination;
					
					showDialog();
				}
				
				setSelectionMark(selectedDevice);
			}
			else {
				translate.setMatrix(translate.matrix.translate(drag.matrix.e, drag.matrix.f));
				drag.setTranslate(0, 0);
			}
		});
	}
	
	function onClick(e) {
		var target = e.target;
		
		if (target.tagName === "image") {
			if (isChartAnchor(target)) {
				opener.showChart(selectedDevice.getAttributeNS(null, "id"));
				
				return;
			}
			else {
				selectedDevice = target;
			}
		}
		else {
			selectedDevice = undefined;
		}
		
		if (selectedDevice) {
			topDevice(selectedDevice);
			
			setSelectionMark(selectedDevice);
		}
		else {
			clearSelectionMark();
		}
		
	}
	
	function cancelClick(e) {
		canvas.addEventListener("click", onClick);
		canvas.removeEventListener("click", cancelClick);
	}
	
	window.resetStage = function () {
		rect = canvas.getBoundingClientRect();
		
		base.setTranslate(rect.width /2, rect.height /2);
	};

	window.getPeers = function () {
		return {
			peer1: deviceData[selectedDevice.getAttributeNS(null, "id")],
			peer2: deviceData[destinationDevice.getAttributeNS(null, "id")]
		};
	};
	
	initialize();
		
}) (window);

/**
 * device
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("device"),
		iconData = opener.getIconData(),
		map = {},
		svgDevice, svgName, device;

	function initialize() {
	}
	
	window.initDevice = function () {
		for (var id in deviceData) {
			device = deviceData[id];
			
			svgDevice = document.createElementNS(svgNS, "image");
			
			svgDevice.setAttributeNS(null, "id", device.id);
			svgDevice.setAttributeNS(null, "x", device.x);
			svgDevice.setAttributeNS(null, "y", device.y);
			svgDevice.setAttributeNS(xlinkNS, "xlink:href", "../"+ iconData[device.type].src);
			svgDevice.setAttributeNS(null, "width", "40px");
			svgDevice.setAttributeNS(null, "height", "40px");
			svgDevice.setAttributeNS(null, "transform", "translate(-20, -20)");
			
			canvas.appendChild(svgDevice);
			
			svgName = document.createElementNS(svgNS, "text");
			
			svgName.textContent = device.name;
			svgName.setAttributeNS(null, "x", device.x);
			svgName.setAttributeNS(null, "y", device.y);
			svgName.setAttributeNS(null, "transform", "translate(0, 25)");
			
			map[id] = svgName;
			
			canvas.appendChild(svgName);
			
			setLine(device);
		}
	};
	
	window.moveDevice = function (svgDevice, x, y) {
		svgName = map[svgDevice.getAttribute("id")];
		
		svgDevice.setAttributeNS(null, "x", x);
		svgDevice.setAttributeNS(null, "y", y);
		
		svgName.setAttributeNS(null, "x", x);
		svgName.setAttributeNS(null, "y", y);
		
		moveLine(svgDevice.getAttributeNS(null, "id"), x, y);
	};
	
	window.topDevice = function (svgDevice) {
		canvas.appendChild(svgDevice);
	};
	
	initialize();
	
}) (window);

/**
 * select
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("select"),
		selectionMark = document.createElementNS(svgNS, "circle"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
		selectionMark.setAttributeNS(null, "r", 30);
	}
		
	window.setSelectionMark = function (svgDevice) {
		var x = Number(svgDevice.getAttributeNS(null, "x")),
			y = Number(svgDevice.getAttributeNS(null, "y"));
		
		selectionMark.setAttributeNS(null, "cx", x);
		selectionMark.setAttributeNS(null, "cy", y);
		
		canvas.appendChild(selectionMark);
		
		showLinkToken(x, y);
	};
	
	window.clearSelectionMark = function () {
		fragment.appendChild(selectionMark);
		
		hideLinkToken();
	};
	
	initialize();
	
}) (window);

/**
 * link
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("link"),
		group = document.getElementById("selected"),
		linkToken = document.createElementNS(svgNS, "circle"),
		link = document.createElementNS(svgNS, "line"),
		chartAnchor = document.createElementNS(svgNS, "image"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
		group.appendChild(link);
		
		linkToken.setAttributeNS(null, "r", 5);
		//linkToken.setAttributeNS(null, "transform", "translate(24, -24)");
		linkToken.setAttributeNS(null, "cursor", "crosshair");
		
		group.appendChild(linkToken);
		
		chartAnchor.setAttributeNS(xlinkNS, "xlink:href", "../img/svg/chart.svg");
		chartAnchor.setAttributeNS(null, "cursor", "pointer");
		chartAnchor.setAttributeNS(null, "width", "16");
		chartAnchor.setAttributeNS(null, "height", "16");
		chartAnchor.setAttributeNS(null, "transform", "translate(-36, -36)");
		
		group.appendChild(chartAnchor);
	}
		
	window.showLinkToken = function (x, y) {
		link.setAttributeNS(null, "x1", x);
		link.setAttributeNS(null, "y1", y);
		link.setAttributeNS(null, "x2", x);
		link.setAttributeNS(null, "y2", y);
		
		linkToken.setAttributeNS(null, "cx", x +24);
		linkToken.setAttributeNS(null, "cy", y -24);
		
		chartAnchor.setAttributeNS(null, "x", x);
		chartAnchor.setAttributeNS(null, "y", y);
		
		canvas.appendChild(group);
	};
	
	window.hideLinkToken = function () {
		fragment.appendChild(group);
	};
	
	window.isLinkToken = function (target) {
		return target === linkToken;
	};
	
	window.isChartAnchor = function (target) {
		return target === chartAnchor;
	};
	
	window.moveLinkToken = function (x, y) {
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y);
		
		link.setAttributeNS(null, "x2", x);
		link.setAttributeNS(null, "y2", y);
	};
	
	initialize();
	
}) (window);

/**
 * interface name
 */
(function (window, undefined) {
	var canvas = document.getElementById("if_name");
	
	window.createLabel = function (name, x1, y1, x2, y2) {
		var nameSvg = document.createElementNS(svgNS, "text");
		
		nameSvg.textContent = name;
		
		moveLabel(nameSvg, x1, y1, x2, y2);
		
		canvas.appendChild(nameSvg);
		
		return nameSvg;
	};
	
	window.moveLabel = function (nameSvg, x1, y1, x2, y2) {
		nameSvg.setAttributeNS(null, "x", (x1 *2 + x2) /3);
		nameSvg.setAttributeNS(null, "y", (y1 *2 + y2) /3);
	};
	
}) (window);

/**
 * line
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("line"),
		map = {};
	
	window.setLine = function (device) {
		var ifEntry = device.ifEntry,
			peerMap = {},
			peer, data, lineSvg,
			nameSvg = document.createElementNS(svgNS, "text");
		
		map[device.id] = peerMap;
		
		for (var name in ifEntry) {
			peer = deviceData[ifEntry[name]];
			
			nameSvg = createLabel(name, device.x, device.y, peer.x, peer.y);
			
			data = map[peer.id];
			
			if (data) {
				data = data[device.id];
				
				data.name2 = nameSvg;
			}
			else {
				lineSvg = document.createElementNS(svgNS, "line");
				
				lineSvg.setAttributeNS(null, "x1", device.x);
				lineSvg.setAttributeNS(null, "y1", device.y);
				lineSvg.setAttributeNS(null, "x2", peer.x);
				lineSvg.setAttributeNS(null, "y2", peer.y);
				
				data = {
					peer1: device.id,
					name1: nameSvg,
					peer2: peer.id,
					svg: canvas.appendChild(lineSvg)
				};
			}
			
			peerMap[peer.id] = data;
		}
	};
	
	window.moveLine = function (id, x, y) {
		var peerMap = map[id],
			data, svgDevice,
			x1, y1, x2, y2;
		
		for (var peerID in peerMap) {
			data = peerMap[peerID];
			svgDevice = data.svg;
			
			if (data.peer1 === id) {
				svgDevice.setAttributeNS(null, "x1", x);
				svgDevice.setAttributeNS(null, "y1", y);
				
				x1 = x;
				y1 = y;
				x2 = Number(svgDevice.getAttributeNS(null, "x2"));
				y2 = Number(svgDevice.getAttributeNS(null, "y2"));
			}
			else {
				svgDevice.setAttributeNS(null, "x2", x);
				svgDevice.setAttributeNS(null, "y2", y);
				
				x1 = Number(svgDevice.getAttributeNS(null, "x1"));
				y1 = Number(svgDevice.getAttributeNS(null, "y1"));
				x2 = x;
				y2 = y;
			}
			
			moveLabel(data.name1, x1, y1, x2, y2);
			moveLabel(data.name2, x2, y2, x1, y1);
		}
	};
	
}) (window);

var deviceData = opener.getDeviceData();

resetStage();

initDevice();

	</script>

	</body>
</html>