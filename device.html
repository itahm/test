<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM::Device</title>
		
		<style>
body,
input,
a {
	font-family: arial, tahoma, "맑은 고딕"
}

li,
select,
input,
span,
label,
a {
	font-size: 12px;
}

aside {
	position: fixed; top: 0; bottom: 0; left: 0; width: 300px;
	box-sizing: border-box;
	padding: 10px;
	overflow-y: auto;
}

section {
	position: fixed; top: 0; right: 0px; bottom: 0; left: 300px;
	box-sizing: border-box;
	padding: 10px;
	background: #fff url(img/chart.png) no-repeat center;
}

.table ul {
	list-style: none;
	padding: 0;
	margin: 0;
	display: flex;
	border-bottom: 1px solid #ddd;
}

.table ul:first-child {
	border-top: 1px solid #ddd;
}

.table li {
	flex: 2;
}

.table li:first-child {
	flex: 1;
	text-align: right;
	background-color: #0084ff;
	color: #ddf;
	font-weight: bold;
}

.table li >* {
	display: block;
	padding: .5em;
}

.table input[type=text],
.table select {
	box-sizing: border-box;
	width: 100%;
}

body.snmp .interface,
.hide,
.snmp:not(body),
#save,
#cancel,
#information:not(.edit) li:nth-child(3),
#information.edit li:nth-child(2),
#information.edit #edit {
	display: none;
}

body.snmp .snmp,
#information.edit li:nth-child(3) {
	display: block;
}

#information.edit #save,
#information.edit #cancel {
	display: inline;
}

li {
	margin: 0;
	vertical-align: bottom;
}

/** chart */

#chart {
	display: flex;
	flex-direction: column;
}

#chart> .chart {
	-webkit-flex: 1;
	flex: 1;
	height: 0;
	position: relative;
}
		
#controller {
	position: absolute; top: 5px; right: 10px; left: 0;
}

#controller > div.right {
	float: right;
}

#controller > div.left {
	float: left;
}

#controller #offline,
#controller.realtime .right,
#controller.realtime .left :not(#offline),
.hidden {
	display: none;
}

#controller.realtime #offline {
	display: inline;
}

#controller img {
	vertical-align: middle;
	border: 1px solid transparent;
}

#controller img.button:hover {
	border-color: #ddf;
	cursor: pointer;
}

#controller a {
	font-weight: bold;
}

#controller a:hover {
	color: #73a4e6;
	text-decoration: underline;
	cursor: pointer;
}
		
		</style>
		
	</head>
	
	<body>
		
		<aside>
			<h3>device information</h3>
			<div class="table information">
				<div id="information">
					<input type="button" value="edit information" id="edit">
					<input type="button" value="save" id="save">
					<input type="button" value="cancel" id="cancel">
				
					<form id="form">
						<ul>
							<li>
								<span>name</span>
							<li>
								<span id="name"></span>
							<li>
								<input type="text" name="name">
						</ul>
						<ul>
							<li>
								<span>ip address</span>
							<li>
								<span id="ip"></span>
							<li>
								<input type="text" name="ip">
						</ul>
						<ul>
							<li>
								<span>type</span>
							<li>
								<span id="type"></span>
							<li>
								<select name="type"></select>
						</ul>
						<ul>
							<li>
								<span>label</span>
							<li>
								<span id="label"></span>
							<li>
								<input type="text" name="label">
						</ul>
						<ul>
							<li>
								<span>snmp</span>
							<li>
								<span id="snmp"></span>
							<li>
								<select name="snmp">
									<option>public
								</select>
						</ul>
					</form>
				</div>
				
				<div class="snmp">
					<ul>
						<li>
							<span>status</span>
						<li>
							<span id="status"></span>
					</ul>
					<ul>
						<li>
							<span>uptime</span>
						<li>
							<span id="uptime"></span>
					</ul>
					<ul>
						<li>
							<span>description</span>
						<li>
							<span id="description"></span>
					</ul>
					<ul>
						<li>
							<span>enterprise</span>
						<li>
							<span id="enterprise"></span>
					</ul>
				</div>
				
			</div>
			
			<div class="snmp">
				<h3>
					snmp response time
				</h3>
				<ul>
					<li><input type="checkbox" id="response">response time (ms)
				</ul>
				
				<h3>
					processor load
				</h3>
				<ul id="processor"></ul>
			
				<h3>
					physical memory
				</h3>
				<ul id="memory"></ul>
				
				<h3>
					storage usage
				</h3>
				<ul id="storage"></ul>
				
				<h3>
					interface throughput
				</h3>
				<ul id="interface"></ul>
			</div>
		</aside>
		
		<section id="chart"></section>
		
		<div class="hidden">
			<div id="controller">
				<div class="right">
					<img src="img/download.png" width="16px" height="16px">
					<a id="csv" title="download chart data as chart.csv">csv</a>
					<a id="png" title="download chart image as chart.png">png</a>
				</div>
				<div class="left">
					<img src="img/chart.png" id="offline" width="16px" height="16px" title="offline chart" class="button">
					<div>
						<img src="img/realtime.png" id="realtime" width="16px" height="16px" title="realtime chart" class="button">
						<img src="img/detail.png" id="detail" width="16px" height="16px" title="detailed chart" class="button">
						<img src="img/calendar.png" width="16px" height="16px">
						<label>
							from
							<input type="date" id="start">
						</label>
						<label>
							to
							<input type="date" id="end">
							<input type="button" value="apply" id="apply">
						</label>
					</div>
				</div>
			</div>
		</div>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/Draggable.js"></script>
		<script src="js/ChartObject.js"></script>
		<script src="js/Chart.js"></script>
		<script>

(function (window, top) {		

	if (window === top) {
		throw "";
	}
	
	var elements = {
			chart: document.getElementById("chart"),
			controller: {
				element : document.getElementById("controller"),
				apply: document.getElementById("apply"),
				png: document.getElementById("png"),
				csv: document.getElementById("csv"),
				start: document.getElementById("start"),
				end: document.getElementById("end"),
				detail: document.getElementById("detail"),
				offline: document.getElementById("offline"),
				realtime: document.getElementById("realtime")
			},
			aside: document.querySelector("aside"),
			form: document.getElementById("form"),
			edit: document.getElementById("edit"),
			cancel: document.getElementById("cancel"),
			save: document.getElementById("save"),
			name: document.getElementById("name"),
			ip: document.getElementById("ip"),
			type: document.getElementById("type"),
			label: document.getElementById("label"),
			snmp: document.getElementById("snmp"),
			status: document.getElementById("status"),
			uptime: document.getElementById("uptime"),
			description: document.getElementById("description"),
			enterprise: document.getElementById("enterprise"),
			information: document.getElementById("information"),
			
			resource: {
				processor: document.getElementById("processor"),
				memory: document.getElementById("memory"),
				storage: document.getElementById("storage"),
				"interface": document.getElementById("interface"),
			}
		},
		titleMap = {
			responseTime: "response time",
			hrProcessorLoad: "processor load",
			hrStorageUsed: "storage usage",
			ifInOctets: "interface throughput input",
			ifOutOctets: "interface throughput output"
		},
		formatMap = {
			responseTime: function (value) {
				return value.toFixed(2) +"ms";
			},
			hrProcessorLoad: function (value) {
				return value.toFixed(2) +"%";
			},
			hrStorageUsed: function (value) {
				return ITAhM.util.toBytesString(value).replace("ytes", "");
			},
			ifInOctets: function (value) {
				return ITAhM.util.toBPSString(value);
			},
			ifOutOctets: function (value) {
				return ITAhM.util.toBPSString(value);
			},
		},
		selectedChart,
		deviceList = top.getDeviceList(),
		snmpList = top.getSNMPList(),
		timer,
		id = 0,
		device;
	
	elements.edit.addEventListener("click", onEdit, false);
	elements.save.addEventListener("click", onSave, false);
	elements.cancel.addEventListener("click", onCancel, false);
	elements.controller.element.addEventListener("mousedown", stopPropagation, false);
	elements.controller.png.addEventListener("click", onDownloadPNG, false);
	elements.controller.csv.addEventListener("click", onDownloadCSV, false);
	//elements.controller.detail.addEventListener("click", onShowDetail, false);
	elements.controller.offline.addEventListener("click", onOffline, false);
	elements.controller.realtime.addEventListener("click", onRealtime, false);
	elements.controller.apply.addEventListener("mousedown", stopPropagation, false);
	elements.controller.apply.addEventListener("click", onApplyDate, false);
	//onChangeSnmp();
	
	elements.controller.start.value = 
	parseType();
	
	resetDevice();
	
	function parseType() {
		var type = elements.form.elements.type,
			map = top.getTypeMap(),
			group, option;
		
		for (var name in map) {
			group = map[name];
			
			option = document.createElement("optgroup");
			option.setAttribute("label", name);
			type.add(option);
			
			for (var i=0, length=group.length; i<length; i++) {
				option.appendChild(document.createElement("option")).text = group[i];
			}
		}
	}
	
	/**
	 * callback method
	 */
	function onFocus(chart) {
		chart.append(elements.controller.element);
		
		selectedChart = chart;
	}
	
	function onDownloadPNG() {
		if (selectedChart) {
			selectedChart.download();
		}
	}
	
	function onDownloadCSV() {
		if (!selectedChart) {
			return;
		}
		
		selectedChart.download();
	}
	
	// TODO offline으로 전환될때 realtime 에 쓰였던 data 초기화 할것
	function onOffline(e) {
		elements.controller.element.classList.remove("realtime");
		
		clearInterval(timer);
		
		//manager.realtime.clear();
	}
	
	function onRealtime(e) {
		elements.controller.element.classList.add("realtime");
		
		timer = setInterval(function () {
			//manager.realtime.update(new Date().getTime(), ###);
		}, 1000);
	}
	
	/*
	 * 시, 분, 초 정보가 없기 때문에 모두 자동으로 0으로 채워지는데,
	 * locale에 따라 시간은 달라지므로 별도로 0으로 채워주어야 함.
	 * start는 해당 일자의 0시로, end는 해당 일자의 24시(다음날의 0시)로 설정.
	 */
	function onApplyDate(e) {
		if (!selectedChart) {
			return;
		}
		
		var start = Date.parse(elements.controller.start.value),
			end = Date.parse(elements.controller.end.value);
		
		if (isNaN(start) || isNaN(end)) {
			return;
		}
		 
		end = new Date(end);
		end.setHours(0);
		
		selectedChart.setDate(new Date(start).setHours(0), end.setDate(end.getDate() +1));
	}
	
	function onCancel() {
		close();
	}
	
	function onEdit(e) {
		edit();
	}
	
	function onSave() {
		save();
	}
	
	function onResponse(request, chart, response, status) {
		if (status === 401) {
			top.unauthorized();
		}
		else if (status === 200) {
			if (request.summary) {
				chart.data = response;
			
				chart.invalidate();
			}
			else {
				chart.showDetail(response);
			}
		}
		else {
			throw "";
		}
	}
	
	/**
	 * monitor하고자 하는 resource check시 chart에 추가하거나 삭제
	 */
	function onCheckResource(database, index, capacity, e) {
		var checkbox = e.currentTarget;
		
		if (!checkbox.checked) {
			return;
		}
		
		var date = new Date(),
			request = {
				command: "query",
				device: device.address,
				database: database,
				index: index,
				summary: true,
				end: date.setMinutes(0, 0, 0),
				start: date.setFullYear(date.getFullYear() -1)
				
			},
			config = {
				title: titleMap[database],
				capacity: capacity,
				onyvalue: formatMap[database]
			},
			chart = new Chart(elements.chart, config);
		
		chart.ondetail = onDetail.bind(undefined, chart, database, index);
		chart.database = database;
		chart.on("mouseenter", onFocus.bind(undefined, chart));
		checkbox.addEventListener("click", onCancelResource.bind(undefined, checkbox, chart), true);
		
		top.sendRequest(request, onResponse.bind(undefined, request, chart));
		
		resize();
	}
	
	function onCancelResource(checkbox, chart, e) {
		var checkbox = e.currentTarget;
		
		if (checkbox.checked) {
			return;
		}
		
		chart.close();
		chart = undefined;
		
		resize();
	}
	
	function onDetail(chart, database, index, start, end) {
		var request = {
			command: "query",
			device: device.address,
			database: database,
			index: index,
			summary: false
		},
		start = new Date(chart.start),
		end = new Date(chart.end);
		
		end.setSeconds(0, 0);
		
		request.start = start.setSeconds(0, 0);
		request.end = end.setMinutes(end.getMinutes() +1);
		console.log(request);
		top.sendRequest(request, onResponse.bind(undefined, request, chart));
	}
	
	function close() {
		elements.information.classList.remove("edit");
	}
	
	function save() {
		if (id === undefined) {
			id = top.createDeviceID();
			device.id = id;
			
			deviceList[id] = device;
		}
		
		device.name = elements.form.name.value;
		device.address = elements.form.ip.value;
		device.type = elements.form.type.value;
		
		var array = [];
		elements.form.label.value.split(",").forEach(function (label) {
			array[array.length] = label.trim();
		});
		
		device.label = array.join(",");
		device.snmp = elements.form.snmp.value;
		
		top.getFrame("list").reload();
		top.getFrame("map").reload();
		
		close();
	}
	
	function edit() {
		restore();
		
		elements.information.classList.add("edit");
	}
	
	function restore() {
		elements.form.elements.name.value = elements.name.textContent;
		elements.form.elements.ip.value = elements.ip.textContent;
		elements.form.elements.type.value = elements.type.textContent;
		elements.form.elements.label.value = elements.label.textContent; 
		elements.form.elements.snmp.value = elements.snmp.textContent;
	}
	
	function resetDevice () {
		device = id !== undefined? deviceList[id]: {
			name: "",
			address: "",
			type: "",
			label: "",
			snmp: "",
			x: 0,
			y: 0
		};
		
		elements.name.textContent = device.name;
		elements.ip.textContent = device.address;
		elements.type.textContent = device.type;
		elements.label.textContent = device.label && (device.label.split(",")).join(", ") || "";
		elements.snmp.textContent = device.snmp;
		
		resetSNMP(device);
		
		if (id === undefined) {
			edit();
		}
	}
	
	function resetSNMP(device) {
		var snmp;
		
		if (device.snmp && device.address && (snmp = snmpList[device.address])) {			
			elements.status.textContent = snmp.timeout < 0? "up": "down";
			elements.description.textContent = snmp.sysDescr;
			elements.uptime.textContent = ITAhM.util.toUptimeString(snmp.hrSystemUptime);
			elements.enterprise.textContent = ITAhM.util.enterpriseFromOID(snmp.sysObjectID);
			
			resetResource(snmp);
			
			document.body.classList.add("snmp");
		}
		else {
			document.body.classList.remove("snmp");
		}
	}
	
	function resetResource(snmp) {
		var checkbox, resource, li;
		
		// delay
		checkbox = document.getElementById("response");
		checkbox.addEventListener("click", onCheckResource.bind(undefined, "responseTime", 0, 3000), false);
		
		// cpu
		for (index in snmp.hrProcessorIndex) {
			checkbox = document.createElement("input");
			checkbox.addEventListener("click", onCheckResource.bind(undefined, "hrProcessorLoad", index, 100), false);
			
			li = document.createElement("li");
			li.appendChild(checkbox).type = "checkbox";
			li.appendChild(document.createElement("span")).textContent = "index."+ index;
			
			elements.resource.processor.appendChild(li);
		}
		
		// storage
		for (index in snmp["hrStorageIndex"]) {
			resource = snmp["hrStorageEntry"][index];
			
			if (resource["hrStorageSize"] === 0) {
				continue;
			}
			
			li = document.createElement("li");
			checkbox = document.createElement("input");
			li.appendChild(checkbox).type = "checkbox";
			
			// physical memory
			if (resource["hrStorageType"] === 2) {				
				li.appendChild(document.createElement("span")).textContent = "index."+ index;
				
				elements.resource.memory.appendChild(li);
			}
			
			// non-removable storage
			else if (resource["hrStorageType"] === 4) {
				li.appendChild(document.createElement("span")).textContent = resource["hrStorageDescr"];
				
				elements.resource.storage.appendChild(li);
			}
			
			checkbox.addEventListener("click", onCheckResource.bind(undefined, "hrStorageUsed", index, resource["hrStorageSize"] * resource["hrStorageAllocationUnits"]), false);
		}
		
		// interface
		for (index in snmp["ifIndex"]) {
			resource = snmp["ifEntry"][index];
			
			checkbox = document.createElement("input");
			
			li = document.createElement("li");
			li.title = resource["ifDescr"];
			li.appendChild(checkbox).type = "checkbox";
			li.appendChild(document.createElement("span")).textContent = resource["ifName"];
			
			checkbox.addEventListener("click", onCheckResource.bind(undefined, "ifInOctets", index, resource["ifSpeed"]), false);
			checkbox.addEventListener("click", onCheckResource.bind(undefined, "ifOutOctets", index, resource["ifSpeed"]), false);
			
			elements.resource["interface"].appendChild(li);
		}
	}
	
	function resize() {
		ITAhM.util.fireEvent("resize", window);
	}
	
	function stopPropagation(e) {
		e.stopPropagation();
	}
	
	/**
	 * public method
	 */
	
	window.resetDevice = function (deviceID) {
		close();
		
		resetDevice(id = deviceID);
		
		elements.aside.scrollTop = 0;
	};
	
	window.getDeviceID = function () {
		return id;
	}
	
})(window, top);

		</script>
	
	</body>
	
</html>