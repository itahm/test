<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Insert title here</title>

		<style>

body.loading #chart {
	visibility: hidden;
}

#chart {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	min-width: 400px;
	min-height: 400px;
}

.left text {
	alignment-baseline: middle;
	text-anchor: end;
}

.right text {
	alignment-baseline: middle;
	text-anchor: start;
}

.date text {
	alignment-baseline: hanging;
	text-anchor: middle;
}

path {
	stroke: #ddd;
	stroke-width: .5;
	fill: none;
}
		</style>
	</head>

	<body class="_loading">
		<svg version="1.1"
			id="chart"
			xmlns="http://www.w3.org/2000/svg"
			width="100%" height="100%">
		</svg>
	</body>
	
	<script src="js/Draggable.js"></script>
	<script src="js/ITAhM.js"></script>
	<script>



var svgNS = "http://www.w3.org/2000/svg",
	MIN_CHART_WIDTH = 100,
	MIN_CHART_HEIGHT = 100,
	MIN_AXIS_VSPACE = 50,
	MIN_AXIS_HSPACE = 160,
	MAX_AXIS_VAL_CNT = 10,
	
	DATE_AXIS_HEIGHT = 50,
	MARGIN = 20;
	PADDING = 5;

function Path(parent) {
	this.initialize(parent);
}

(function (window, undefined) {
	
	Path.prototype = {
		initialize: function () {
			this.path = document.createElementNS("http://www.w3.org/2000/svg", "path");
			
			this.beginPath();
		},
		
		moveTo: function (x, y) {
			this.distance[this.distance.length] = "M"+ x +" "+ y;
			
			return this;
		},
		
		lineTo: function (x, y) {
			this.distance[this.distance.length] = "L"+ x +" "+ y;
			
			return this;
		},
		
		stroke: function (svgElement) {
			this.path.setAttributeNS(null, "d", this.distance.join(" "));
			this.path.setAttributeNS(null, "stroke", this.strokeStyle || "#0000");
			
			svgElement.appendChild(this.path);
		},
		
		fill: function (svgElement) {
			this.path.setAttributeNS(null, "d", this.distance.join(" "));
			this.path.setAttributeNS(null, "fill", this.fillStyle || "#0000");
		},
		
		beginPath: function () {
			this.distance = [];
		},
		
		closePath: function () {
			this.distance[this.distance.length] = "Z"
		}
	};
	
}) (window);

function Chart(svg) {
	this.initialize(svg);
}

function valueToString(value) {
	return value;
}

(function (window, undefined) {
	function onResize(chart, e) {
		clearTimeout(chart.timer);
		
		chart.timer = setTimeout(chart.invalidate.bind(chart), 300);
	}
	
	Chart.prototype = {
		initialize: function (svg) {
			this.body = svg;
			this.chart = document.createElementNS(svgNS, "svg");
			this.container = document.createElementNS(svgNS, "g");
			this.leftAxis = new LeftAxis(this);
			this.rightAxis = new RightAxis(this);
			this.dateAxis = new DateAxis(this);
			this.graph = new Graph(this);
			this.grid = new Grid(this);
			this.data = new ChartSummaryData(createData());
			this.start = new Date(2015, 10, 6, 0, 0, 0, 0);
			this.end = new Date(2015, 10, 6, 23, 59, 0, 0);
			
			var data = this.data.buildData(this.start, this.end);
			this.high = data.high;
			this.low = data.low;
			
			this.container.setAttribute("transform", "translate(20, 20)");
			
			var transformList = this.container.transform.baseVal;
			
			this.transform = {
				translate: transformList.getItem(0)
			};
			
			svg.appendChild(this.chart).appendChild(this.container);
			
			window.addEventListener("resize", onResize.bind(undefined, this));
			
			this.invalidate();
		},
		
		invalidate: function () {
			var rect = this.body.getBoundingClientRect(),
				width = rect.width,
				height = rect.height,
				data = {};
			
			// high와 low가 결정되지 않았으면 다시 그리지 않음
			if (typeof this.high !== "number" || typeof this.low !== "number") {
				throw "";
			}
			
			//window resize 발생 했으나 chart 크기 변화는 없음
			if (width === this.width && height === this.height) {
				return;
			}
			
			this.width = width;
			this.height = height;
			
			// padding 제외
			width -= MARGIN *2;
			
			//padding 과 date 축 제외
			height -= (MARGIN *2 + DATE_AXIS_HEIGHT);
			
			//height 확정되면 count, space, grow 계산
			var count = Math.min(MAX_AXIS_VAL_CNT, Math.round(height / MIN_AXIS_VSPACE)),
				space = height / count,
				grow = (this.high - this.low) / count,
				x, xx;
			
			this.tpp = (this.end - this.start / width); 
			
			this.leftAxis.draw(count, space, this.high, grow);
			
			//x left 축 너비
			x = this.leftAxis.getSize().width;
			
			this.leftAxis.setTranslate(x, 0);
			
			this.rightAxis.draw(count, space, this.high, grow)
			
			// xx right 축 너비
			xx = this.rightAxis.getSize().width;
			
			this.rightAxis.setTranslate(width - xx, 0);
			
			width -= (x + xx);
			
			// width
			this.dateAxis.setSize(width, DATE_AXIS_HEIGHT);
			this.dateAxis.setTranslate(0, height);
			this.dateAxis.draw(this.start, this.end, this.tpp);
			
			// x, width, height
//			this.graph.resize(x +PADDING, width - PADDING *2, height);
			
			// x, width, height
			this.grid.setTranslate(x, 0);
			this.grid.setSize(width, height);
			
			this.grid.draw(Math.round(width) -.5, space, count);
		},
		
		add: function (svgElement) {
			this.container.appendChild(svgElement);
		}
	};
	
}) (window);

function SVGChart() {
}

(function (window, undefined) {
	
	function setTransform(svgChart) {
		var transformList = svgChart.container.transform.baseVal;
		
		svgChart.setTranslate = function (x, y) {
			transformList.getItem(0).setTranslate(x, y);
		};
		
		svgChart.setScale = function (x, y) {
			transformList.getItem(0).setScale(x, y || x);
		};
	}
	
	SVGChart.prototype = {
		initialize: function (chart, config) {
			this.chart = chart;
			
			this.container = document.createElementNS(svgNS, "g");
			
			this.container.setAttribute("transform", "translate(0, 0) scale(1, 1)");
			
			setTransform(this);
			
			chart.add(this.container);
		},
		
		getSize: function () {
			return this.container.getBBox();
		},
		
		setSize: function (width, height) {
			this.container.setAttributeNS(null, "width", width);
			this.container.setAttributeNS(null, "height", height);
		},
		
		clear: function () {
			var svgElement;
			
			while(svgElement = this.container.firstChild) {
				this.container.removeChild(svgElement);
			}
		},
		
		addText: function (x, y, text) {
			var svgText = document.createElementNS(svgNS, "text");
			
			svgText.setAttributeNS(null, "x", x);
			svgText.setAttributeNS(null, "y", y);
			svgText.textContent = text;
			
			this.container.appendChild(svgText);
		}
	};

}) (window);

function Axis(chart, config) {
	if(arguments.length > 0) {
		this.initialize(chart, config || {});
	}
}

(function (window, undefined) {
	
	Axis.prototype = new SVGChart();
	
	Axis.prototype.initialize = function (chart, config) {
		SVGChart.prototype.initialize.call(this, chart, config);
	};
	
	Axis.prototype.draw = function (count, space, high, grow) {
		this.clear();
		
		for (var i=0; i<=count; i++) {
			this.addText(0, space * i, (this.valueToString || valueToString) ((high - i * grow), high));
		}
	};
	
}) (window);

function LeftAxis(chart, config) {
	this.initialize(chart, config || {});
}

(function (window, undefined) {
	
	LeftAxis.prototype = new Axis();
	
	LeftAxis.prototype.initialize = function (chart, config) {
		Axis.prototype.initialize.call(this, chart, config);
			
		this.container.classList.add("left");
	};
	
	LeftAxis.prototype.valueToString = function (value, capacity) {
		return value.toFixed(2);
	};
	
}) (window);

function RightAxis(chart, config) {
	this.initialize(chart, config || {});
}

(function (window, undefined) {
	
	RightAxis.prototype = new Axis();
	
	RightAxis.prototype.initialize = function (chart, config) {
		SVGChart.prototype.initialize.call(this, chart, config);
			
		this.container.classList.add("right");
	};
	
	RightAxis.prototype.valueToString = function (value, capacity) {
		return (value / capacity *100).toFixed(2) +"%";
	};
	
}) (window);

function DateAxis(chart, config) {
	this.initialize(chart, config || {});
}

(function (window, undefined) {
	
	DateAxis.prototype = new SVGChart();
	
	DateAxis.prototype.initialize = function (chart, config) {
		SVGChart.prototype.initialize.call(this, chart, config);
			
		this.container.classList.add("date");
	};
	
	DateAxis.prototype.draw = function (start, end, tpp) {
		var text,
			mills = start.setHours(start.getHours() +1, 0, 0, 0),
			offset = start - mills,
			x;
		
		x = offset / tpp;
		console.log(0);
		if (x > MIN_AXIS_HSPACE) {console.log(1);
			addText(x, 0, ITAhM.util.toDateFormatString(new Date(mills)));
		}this.addText(x, 0, ITAhM.util.toDateFormatString(new Date(mills)));
		console.log(2);
		/*
		
		this.clear();
		
		for (var i=0; i<=count; i++) {
			text = document.createElementNS(svgNS, "text");
			
			text.setAttributeNS(null, "x", 0);
			text.setAttributeNS(null, "y", space * i);
			text.textContent = (this.valueToString || valueToString) ((high - i * grow), high);
			
			this.container.appendChild(text);
		}
		*/
		//this.container.setAttributeNS(null, "width", width);
	};
	
}) (window);

function Graph(chart, config) {
	this.initialize(chart, config || {});
}

(function (window, undefined) {
	
	Graph.prototype = new SVGChart();
	
	Graph.prototype.initialize = function (chart, config) {
		SVGChart.prototype.initialize.call(this, chart, config);
		
		this.container.classList.add("graph");
	};
	
	Graph.prototype.setDate = function (start, end) {
		this.start = start;
		this.end = end;
		
		this.tpp = (end - start / this.width);
	};
	
	Graph.prototype.setSize = function (width, height) {
		SVGChart.prototype.setSize.call(this, width, height);
		
		this.width = width;
		this.tpp = (this.end - this.start / width);
	};
	
	Graph.prototype.draw = function () {
		//new Path(this.container).moveTo(0, 0).lineTo(0, 500).stroke();
	};
			
}) (window);

function Grid(chart, config) {
	this.initialize(chart, config || {});
}

(function (window, undefined) {
	
	Grid.prototype = new SVGChart();
	
	Grid.prototype.initialize = function (chart, config) {
		SVGChart.prototype.initialize.call(this, chart, config);
		
		this.path = new Path();
		
		this.container.classList.add("graph");
	};
	
	Grid.prototype.draw = function (x, space, count) {
		var rect = this.container.getBBox(),
			y;
		
		this.path.beginPath();
		
		for (var i=0; i<=count; i++) {
			y = Math.round(i * space) -.5;
			
			this.path.moveTo(0, y);
			this.path.lineTo(x, y);
		}
		
		this.path.moveTo(PADDING, 0);
		this.path.lineTo(PADDING, y);
		
		this.path.moveTo(x - PADDING, 0);
		this.path.lineTo(x - PADDING, y);
		
		this.path.strokeStyle = "#cccccc";
		this.path.stroke(this.container);
	};
	
}) (window);

function ChartData(data) {
	if (arguments.length > 0) {
		this.initialize(data);
	}
}

(function (window, undefined) {
	
	ChartData.prototype = {
		initialize: function (data) {
			this.data = data;
		},
		
		next: function (date) {
			return date.setMinutes(date.getMinutes() +1, 0, 0);
		},
		
		buildData: function (start, end, unit) {
			var keys = [],
				tmp = [],
				date = new Date(start),
				value, high, low;
			
			while (this.next(date) < end) {
				value = this.data[mills];
				
				if (value) {
					tmp[tmp.length] = mills;
					
					high = Math.max(value, high || value);
					low = Math.min(value, low || value);
				}
				else if (tmp.length > 0) {
					data[data.length] = tmp;
					
					tmp = [];
				}
			}
			
			if (tmp.length > 0) {
				data[data.length] = tmp;
			}
			
			return {
				high: high,
				low: low,
				keys: keys
			}
		}
		
	};
	
}) (window);

function ChartSummaryData(data) {
	if (arguments.length > 0) {
		this.initialize(data);
	}
}

(function (window, undefined) {
	
	ChartSummaryData.prototype = {
		initialize: function (data) {
			this.data = data;
		},
		
		next: function (date) {
			return date.setHours(date.getHours() +1, 0, 0, 0);
		},
		
		buildData: function (start, end) {
			var keys = [],
				tmp = [],
				date = new Date(start),
				mills, value, high, low;
			
			while ((mills = this.next(date)) < end) {
				value = this.data[mills];
				
				if (value) {
					tmp[tmp.length] = mills;
					
					high = Math.max(value.max, high || value.max);
					low = Math.min(value.min, low || value.min);
				}
				else if (tmp.length > 0) {
					keys[keys.length] = tmp;
					
					tmp = [];
				}
			}
			
			if (tmp.length > 0) {
				data[data.length] = tmp;
			}
			
			return {
				high: high,
				low: low,
				keys: keys
			}
		}
	};
	
}) (window);

new Chart(chart);

function createData() {
	return {
	    "1446757200000": {
	        "avg": 0,
	        "min": 0,
	        "max": 2
	    },
	    "1446760800000": {
	        "avg": 0,
	        "min": 0,
	        "max": 0
	    },
	    "1446746400000": {
	        "avg": 0,
	        "min": 0,
	        "max": 0
	    },
	    "1446771600000": {
	        "avg": 0,
	        "min": 0,
	        "max": 3
	    },
	    "1446742800000": {
	        "avg": 0,
	        "min": 0,
	        "max": 1
	    },
	    "1446753600000": {
	        "avg": 0,
	        "min": 0,
	        "max": 0
	    },
	    "1446764400000": {
	        "avg": 0,
	        "min": 0,
	        "max": 0
	    },
	    "1446775200000": {
	        "avg": 2,
	        "min": 0,
	        "max": 29
	    },
	    "1446782400000": {
	        "avg": 3,
	        "min": 0,
	        "max": 9
	    },
	    "1446739200000": {
	        "avg": 0,
	        "min": 0,
	        "max": 0
	    },
	    "1446796800000": {
	        "avg": 1,
	        "min": 0,
	        "max": 17
	    },
	    "1446750000000": {
	        "avg": 0,
	        "min": 0,
	        "max": 11
	    },
	    "1446786000000": {
	        "avg": 1,
	        "min": 0,
	        "max": 9
	    },
	    "1446793200000": {
	        "avg": 1,
	        "min": 0,
	        "max": 7
	    },
	    "1446735600000": {
	        "avg": 0,
	        "min": 0,
	        "max": 1
	    },
	    "1446789600000": {
	        "avg": 0,
	        "min": 0,
	        "max": 8
	    },
	    "1446768000000": {
	        "avg": 0,
	        "min": 0,
	        "max": 0
	    },
	    "1446778800000": {
	        "avg": 2,
	        "min": 0,
	        "max": 13
	    }
	};
}
	</script>
</html>