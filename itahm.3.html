<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM(connecting...)</title>
		
		<style>
body, input, button {
	font-family: tahoma, arial, "맑은 고딕";
	margin: 0;
	padding: 0; 
}

aside {
	position: fixed; top: 0; left: 0;
	height: 0;
	width: 400px;
	background-color: #fff;
	transition: height .2s ease-in;
}

iframe {
	width: 100%; height: 100%;
	border: 0;
	margin: 0;
	padding: 0;
}

body.list aside {
	bottom: 0;
	height: 100%;
}

#frame_list {
	width: 500px;
}

#show_list {
	position: fixed; top: 10px; left: 10px;
	cursor: pointer;
}

#hide_list {
	position: absolute; top: 10px; right: 0;
	cursor: pointer;
}

body:not(.list) #hide_list {
	display: none;
}

/* svg*/
svg {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
}

image {
	fill: #f00;
}

#line line {
	stroke: #0f0;
	stroke-width: 2;
}

#navigation line {
	stroke: #800;
	stroke-width: 2;
}

text {
	font-family: tahoma, arial, "맑은 고딕";
	font-size: 10px;
	fill: #000;
	text-anchor: middle;
}

#if_name text {
	fill: #777;
}

#device text {
	font-size: 12px;
	alignment-baseline: hanging;
	fill: #000;
}

#selection circle {
	stroke: #fdd400;
	stroke-width: 2px;
	fill: #ff0;
}

#navigation circle {
	stroke: #800;
	stroke-width: 1px;
	fill: #f00;
}

body.loading #navigation,
body.loading #selection,
#navigation:not(.chart) #chart_anchor {
	display: none;
}

/* dialog */
body:not(.dialog) #dialog {
	display: none;
}

/* chart */
#chart {
	background-color: #fff;
}

body:not(.chart) #chart {
	display: none;
}

/* 공통 */
.fullscreen {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
}

body.nolink #link_token {
	display: none;
}

		</style>
		
	</head>
	
	<body class="loading nolink">
	
		<svg id="stage">
			<g id="transform" transform="translate(0, 0) translate(0, 0) translate(0, 0) scale(1, 1)">
				<g id="line"></g>
				<g id="if_name"></g>
				<g id="selection">
					<circle id="selection_mark" r="30"></circle>
				</g>
				<g id="navigation">
					<g id="tool">
						<image xlink:href="../img/svg/chart.svg" id="chart_anchor"
							transform="translate(-42, -8)" width="16" height="16" cursor="pointer">
						</image>
						<image xlink:href="../img/svg/information.svg" id="edit_anchor"
							transform="translate(26, -8)" width="16" height="16" cursor="pointer">
						</image>
						<line id="link_line"></line>
						<circle id="link_token" r="5" cursor="crosshair"></circle>
					</g>
				</g>
				<g id="device"></g>
			</g>
		</svg>
		
		<img src="img/list.png" id="show_list" title="show device list">
		
		<aside>
			<img src="img/close.png" id="hide_list" title="hide device list">
			<iframe id="device_list"></iframe>
		</aside>
		
		<iframe id="dialog" class="fullscreen"></iframe>
		
		<iframe id="chart" class="fullscreen"></iframe>
		
		<script src="../js/Draggable.js"></script>
		<script>

if (!opener) throw "";

var svgNS = "http://www.w3.org/2000/svg",
	xlinkNS = "http://www.w3.org/1999/xlink";

var deviceData = opener.getDeviceData(),
	iconData = opener.getIconData();

//device list
(function (window, undefined){
	
	var frame = document.getElementById("device_list"),
		show = document.getElementById("show_list"),
		hide = document.getElementById("hide_list");
	
	function initialize() {
		show.onclick = function () {
			document.body.classList.add("list");
			
			frame.onload = onLoad;
			
			frame.src = "device_list.html";
		};
		
		hide.onclick = function () {
			document.body.classList.remove("list");
			
			frame.src = "about:blank";
		};
	}
	
	function onLoad() {
		
	}
	
	window.hideDeviceList = function () {
		document.body.classList.remove("list");
	};
	
	initialize();
	
}) (window);

//device 관리
(function (window, undefined) {
	
	var tmpID = -1;
	
	window.createDevice = function () {
		var id = tmpID--;
		
		device.id = id;
		device.x = 0;
		device.y = 0;
		
		deviceData[id] = device;
	};
	
}) (window);

// stage
(function (window, undefined) {
	var canvas = document.getElementById("stage"),
		base, translate, scale, ratio = 1,
		selectedDevice,
		deviceMap = {},
		dragOrigin;
	
	function initialize() {		
		initEvent();
		
		resetStage();
		
		clearSelectionMark();
		
		for (var id in deviceData) {
			device = deviceData[id];
			
			svgDevice = document.createElementNS(svgNS, "image");
			
			deviceMap[id] = svgDevice;
			
			addDevice(svgDevice, device);
		}
		
		document.body.classList.remove("loading");
	}
	
	function initEvent() {
		var transformList = document.getElementById("transform").transform.baseVal;
	
		new Draggable(canvas);
			
		base = transformList.getItem(0);
		translate = transformList.getItem(1);
		drag = transformList.getItem(2);
		scale = transformList.getItem(3);
		
		window.addEventListener("resize", function (e) {
			resetStage();
		});
		
		canvas.addEventListener("selectstart", function (e) {
			e.preventDefault();
		});
		
		canvas.addEventListener("wheel", function (e) {
			if (e.deltaY < 0) {
				//확대
				ratio *= 1.1;
			}
			else {
				//축소
				ratio /= 1.1;
			}
			
			scale.setScale(ratio, ratio);
		});
		
		canvas.addEventListener("click", onClick);
		
		canvas.addEventListener("dragstart", function (e) {
			var data = e.detail,
				target = data.target;
			
			// drag 발생시 select 취소
			canvas.addEventListener("click", cancelClick);
			canvas.removeEventListener("click", onClick);
			
			if (target.tagName === "image") {
				dragOrigin = {
					x: Number(target.getAttributeNS(null, "x")),
					y: Number(target.getAttributeNS(null, "y"))
				};
			}
			else if (target.tagName === "circle") {
				dragOrigin = {
					x: Number(target.getAttributeNS(null, "cx")),
					y: Number(target.getAttributeNS(null, "cy"))
				};
			}
		});
		
		canvas.addEventListener("dragmove", function (e) {
			var data = e.detail,
				target = data.target;
		
			// selectedDevice 인 경우 moveDevice
			if (target === selectedDevice) {
				moveDevice(dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
				
				setSelectionMark();
			}
			// linkToken 인 경우 moveLinkToken
			else if (isLinkToken(target)){
				var destination = data.destination;
				
				if (destination !== target && destination.tagName === "image") {
					moveLinkToken(Number(destination.getAttributeNS(null, "x")), Number(destination.getAttributeNS(null, "y")));
				}
				else {
					moveLinkToken(dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
				}
			}
			// 그렇지 않은 모든 경우 moveStage
			else {
				drag.setTranslate(data.dragX, data.dragY);
			}
		});
		
		canvas.addEventListener("dragend", function (e) {
			var data = e.detail,
				target = data.target,
				destination = data.destination;
			
			if (target === selectedDevice) {
			}
			else if (isLinkToken(target)){
				if (destination.tagName === "image") {
					showLinkDialog(function (dialog) {
						dialog.setLink(deviceData[selectedDevice.getAttributeNS(null, "id")], deviceData[destination.getAttributeNS(null, "id")]);
					});
				}
				
				setSelectionMark();
			}
			else {
				translate.setMatrix(translate.matrix.translate(drag.matrix.e, drag.matrix.f));
				drag.setTranslate(0, 0);
			}
		});
	}
	
	function onClick(e) {
		var target = e.target;
	
		selectedDevice = target.tagName === "image"? target: undefined;
		
		if (selectedDevice) {
			topDevice(selectedDevice);
			
			setSelectionMark();
		}
		else {
			clearSelectionMark();
		}
	
	}
	
	function cancelClick(e) {
		canvas.addEventListener("click", onClick);
		canvas.removeEventListener("click", cancelClick);
	}
	
	// public
	window.resetStage = function () {
		rect = canvas.getBoundingClientRect();
		
		base.setTranslate(rect.width /2, rect.height /2);
	};
	
	window.moveStage = function (x, y) {
		translate.setTranslate(- x, - y);
	};
	
	window.getSelectedDeviceID = function () {
		return selectedDevice.getAttributeNS(null, "id");
	};
	
	window.getSvgDevice = function (id) {
		return deviceMap[id];
	};
	
	window.getDevice = function (id) {
		return deviceData[id];
	};
	
	window.editDevice = function () {
	
	};
	
	window.getDeviceData = function () {
		return deviceData;
	};
	
	window.initialize = initialize;

}) (window);

// svg device group
(function (window, undefined) {
	
	var canvas = document.getElementById("device"),
		deviceMap = {},
		nameMap = {},
		svgDevice, svgName, device;

	function initialize() {
	}
	
	window.addDevice = function (svgDevice, device) {
		var id = device.id;
		
		svgDevice.setAttributeNS(null, "id", id);
		svgDevice.setAttributeNS(null, "x", device.x);
		svgDevice.setAttributeNS(null, "y", device.y);
		svgDevice.setAttributeNS(xlinkNS, "xlink:href", "../"+ iconData[device.type].src);
		svgDevice.setAttributeNS(null, "width", "40px");
		svgDevice.setAttributeNS(null, "height", "40px");
		svgDevice.setAttributeNS(null, "transform", "translate(-20, -20)");
		
		canvas.appendChild(svgDevice);
		
		svgName = document.createElementNS(svgNS, "text");
		
		svgName.textContent = device.name;
		svgName.setAttributeNS(null, "x", device.x);
		svgName.setAttributeNS(null, "y", device.y);
		svgName.setAttributeNS(null, "transform", "translate(0, 25)");
		
		nameMap[id] = svgName;
		
		canvas.appendChild(svgName);
		
		setLine(device);
	};
	
	window.moveDevice = function (x, y) {
		var id = getSelectedDeviceID(),
			svgDevice = getSvgDevice(id);
		
		svgName = nameMap[id];
		
		svgDevice.setAttributeNS(null, "x", x);
		svgDevice.setAttributeNS(null, "y", y);
		
		svgName.setAttributeNS(null, "x", x);
		svgName.setAttributeNS(null, "y", y);
		
		moveLine(id, x, y);
	};
	
	window.topDevice = function (svgDevice) {
		canvas.appendChild(svgDevice);
	};
	
	initialize();
	
}) (window);

// svg select group
(function (window, undefined) {
	
	var canvas = document.getElementById("selection"),
		selectionMark = document.getElementById("selection_mark"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
	}
		
	window.setSelectionMark = function () {
		var id = getSelectedDeviceID(),
			device = deviceData[id],
			svgDevice = getSvgDevice(id),
			x = Number(svgDevice.getAttributeNS(null, "x")),
			y = Number(svgDevice.getAttributeNS(null, "y"));
		
		selectionMark.setAttributeNS(null, "cx", x);
		selectionMark.setAttributeNS(null, "cy", y);
		
		canvas.appendChild(selectionMark);
		
		showNavigation(x, y, device.snmp);
	};
	
	window.clearSelectionMark = function () {
		fragment.appendChild(selectionMark);
		
		hideNavigation();
	};
	
	initialize();
	
}) (window);

// svg navigation group
(function (window, undefined) {
	
	var canvas = document.getElementById("navigation"),
		navigation = document.getElementById("tool"),
		linkToken = document.getElementById("link_token"),
		svgLink = document.getElementById("link_line"),
		chartAnchor = document.getElementById("chart_anchor"),
		editAnchor = document.getElementById("edit_anchor"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
		chartAnchor.onclick = function (e) {
			e.stopPropagation();
			
			showChart();
		};
		
		editAnchor.onclick = function (e) {
			e.stopPropagation();
			
			var id = getSelectedDeviceID(),
				device = deviceData[id];
			
			if (device.snmp) {
				sendRequest({
					command: "select",
					ip: device.ip
				}, onResponse, true);
			}
			else {
				onLoadDeviceDialog();
			}
		};
	}
	
	function onResponse(data) {
		if (data) {
			onLoadDeviceDialog(data);
		}
		else {
			window.close();
		}
	}
	
	function onLoadDeviceDialog(snmp) {
		var id = getSelectedDeviceID(),
			device = deviceData[id];
		
		showDeviceDialog(function (dialog) {
			dialog.initialize(iconData);
			
			dialog.setDevice(device, snmp);
		});
	}
	
	window.showNavigation = function (x, y, chart) {
		svgLink.setAttributeNS(null, "x1", x);
		svgLink.setAttributeNS(null, "y1", y);
		svgLink.setAttributeNS(null, "x2", x);
		svgLink.setAttributeNS(null, "y2", y);
		
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y -32);
		
		chartAnchor.setAttributeNS(null, "x", x);
		chartAnchor.setAttributeNS(null, "y", y);
		
		editAnchor.setAttributeNS(null, "x", x);
		editAnchor.setAttributeNS(null, "y", y);
		
		canvas.classList[chart? "add": "remove"]("chart");
		
		canvas.appendChild(navigation);
	};
	
	window.isLinkToken = function (target) {
		return target === linkToken;
	};
	
	window.hideNavigation = function () {
		fragment.appendChild(navigation);
	};
	
	window.moveLinkToken = function (x, y) {
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y);
		
		svgLink.setAttributeNS(null, "x2", x);
		svgLink.setAttributeNS(null, "y2", y);
	};
	
	initialize();
	
}) (window);

// svg interface name group
(function (window, undefined) {
	var canvas = document.getElementById("if_name");
	
	window.createLabel = function (name, x1, y1, x2, y2) {
		var nameSvg = document.createElementNS(svgNS, "text");
		
		nameSvg.textContent = name;
		
		moveLabel(nameSvg, x1, y1, x2, y2);
		
		canvas.appendChild(nameSvg);
		
		return nameSvg;
	};
	
	window.moveLabel = function (nameSvg, x1, y1, x2, y2) {
		nameSvg.setAttributeNS(null, "x", (x1 *2 + x2) /3);
		nameSvg.setAttributeNS(null, "y", (y1 *2 + y2) /3);
	};
	
}) (window);

// svg line group
(function (window, undefined) {
	
	var canvas = document.getElementById("line"),
		lineMap = {};
	
	window.setLine = function (device) {
		var ifEntry = device.ifEntry,
			peerMap = {},
			peer, data, lineSvg,
			nameSvg = document.createElementNS(svgNS, "text");
		
		lineMap[device.id] = peerMap;
		
		for (var name in ifEntry) {
			peer = deviceData[ifEntry[name]];
			
			nameSvg = createLabel(name, device.x, device.y, peer.x, peer.y);
			
			data = lineMap[peer.id];
			
			if (data) {
				data = data[device.id];
				
				data.name2 = nameSvg;
			}
			else {
				lineSvg = document.createElementNS(svgNS, "line");
				
				lineSvg.setAttributeNS(null, "x1", device.x);
				lineSvg.setAttributeNS(null, "y1", device.y);
				lineSvg.setAttributeNS(null, "x2", peer.x);
				lineSvg.setAttributeNS(null, "y2", peer.y);
				
				data = {
					peer1: device.id,
					name1: nameSvg,
					peer2: peer.id,
					svg: canvas.appendChild(lineSvg)
				};
			}
			
			peerMap[peer.id] = data;
		}
	};
	
	window.moveLine = function (id, x, y) {
		var peerMap = lineMap[id],
			data, svgDevice,
			x1, y1, x2, y2;
		
		for (var peerID in peerMap) {
			data = peerMap[peerID];
			svgDevice = data.svg;
			
			if (data.peer1 === id) {
				svgDevice.setAttributeNS(null, "x1", x);
				svgDevice.setAttributeNS(null, "y1", y);
				
				x1 = x;
				y1 = y;
				x2 = Number(svgDevice.getAttributeNS(null, "x2"));
				y2 = Number(svgDevice.getAttributeNS(null, "y2"));
			}
			else {
				svgDevice.setAttributeNS(null, "x2", x);
				svgDevice.setAttributeNS(null, "y2", y);
				
				x1 = Number(svgDevice.getAttributeNS(null, "x1"));
				y1 = Number(svgDevice.getAttributeNS(null, "y1"));
				x2 = x;
				y2 = y;
			}
			
			moveLabel(data.name1, x1, y1, x2, y2);
			moveLabel(data.name2, x2, y2, x1, y1);
		}
	};
	
}) (window);

// dialog
(function (window, undefined) {
	
	var dialog = document.getElementById("dialog");
	
	function showDialog(onload) {
		document.body.classList.add("dialog");
		
		onload(dialog.contentWindow);
	}
	
	window.showDeviceDialog = function (onload) {
		dialog.onload = showDialog.bind(undefined, onload);
		
		dialog.src = "device.html";
	};
	
	window.showLinkDialog = function (onload) {
		dialog.onload = showDialog.bind(undefined, onload);
		
		dialog.src = "link.html";
	};
	
	window.closeDialog = function () {
		document.body.classList.remove("dialog");
		
		dialog.onload = undefined;
		
		dialog.src = "about:blank";
	};
	
}) (window);

//chart
(function (window, undefined) {
	
	var chart = document.getElementById("chart"),
		device;
	
	function onResponse(data) {
		if (data) {
			chart.onload = function () {
				chart.contentWindow.initialize(device, data);
			};
			
			chart.src = "chart.html";
		}
		else {
			window.close();
		}
		
		document.body.classList.add("chart");
	}
	
	window.showChart = function () {
		device = deviceData[getSelectedDeviceID()];
		
		sendRequest({
			command: "select",
			ip: device.ip
		}, onResponse);
	};
	
	window.closeChart = function () {
		document.body.classList.remove("chart");
		
		chart.onload = undefined;
		
		dialog.src = "about:blank";
	};
	
}) (window);

function selectDevice(id) {
	var svgDevice = getSvgDevice(id);
	
	x = Number(svgDevice.getAttributeNS(null, "x"));
	y = Number(svgDevice.getAttributeNS(null, "y"));
	
	moveStage(x, y);
}

function sendRequest(request, callback) {
	opener.sendRequest(request, callback);
}

initialize();

		</script>
	
	</body>
	
</html>