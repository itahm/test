<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Insert title here</title>

		<style>
svg {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	width: 100%; height: 100%;
}

image {
	fill: #f00;
}

#line line {
	stroke: #0f0;
	stroke-width: 2;
}

#navigation line {
	stroke: #800;
	stroke-width: 2;
}

text {
	font-family: tahoma, arial, "맑은 고딕";
	font-size: 10px;
	fill: #000;
	text-anchor: middle;
}

#if_name text {
	fill: #777;
}

#device text {
	font-size: 12px;
	alignment-baseline: hanging;
	fill: #000;
}

#selection circle {
	stroke: #fdd400;
	stroke-width: 2px;
	fill: #ff0;
}

#navigation circle {
	stroke: #800;
	stroke-width: 1px;
	fill: #f00;
}

iframe {
	
}

iframe[src="about:blank"] {
	display: none;
}

#navigation:not(.chart) #chart_anchor,
body.loading #navigation,
body.loading #selection,
body.maximized #maximize,
body:not(.maximized) #minimize,
body:not(.dialog) .dialog {
	display: none;
}

nav {
	position: fixed; top: 10px; right: 10px;
}

nav img {
	cursor: pointer;
}

/* link dialog */
.dialog {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	background-color: rgba(255, 255, 255, .9);
	display: flex;
	justify-content: center;
	align-items: center;
}

.dialog form {
	padding: 20px;
	background-color: #fff;
	box-shadow: 0px 0px 20px 10px #ddd;
}

.dialog footer input {
	width: 100px;
	padding: .5em;
}

.dialog footer {
	margin-top: 20px;
	text-align: right;
}


#link .main {
	width: 480px;
	display: flex;
	justify-content: space-around;
}

#link select {
	padding: .5em;
	width: 100%;
	box-sizing: border-box;
}

.peer {
	width: 200px;
}

		</style>
	</head>

	<body class="loading">
		
		<svg id="stage">
			<g id="transform" transform="translate(0, 0) translate(0, 0) translate(0, 0) scale(1, 1)">
				<g id="line"></g>
				<g id="if_name"></g>
				<g id="selection">
					<circle id="selection_mark" r="30"></circle>
				</g>
				<g id="navigation">
					<g id="tool">
						<image xlink:href="../img/svg/chart.svg" id="chart_anchor"
							transform="translate(-42, -8)" width="16" height="16" cursor="pointer">
						</image>
						<image xlink:href="../img/svg/information.svg" id="edit_anchor"
							transform="translate(26, -8)" width="16" height="16" cursor="pointer">
						</image>
						<line id="link_line"></line>
						<circle id="link_token" r="5" cursor="crosshair"></circle>
					</g>
				</g>
				
				<g id="device"></g>
			</g>
		</svg>
		
		<nav>
			<img alt="restore map" src="../img/minimize.png" id="minimize">
			<img alt="maximize map" src="../img/maximize.png" id="maximize">
		</nav>
		
		<iframe id="_dialog"></iframe>
		
		<section class="dialog">
			<form id="link">
				<div class="main">
					<div class="peer">
						<h2 id="name1">peer1</h2>
						<select name="entry1" class="snmp" required></select>
					</div>
					<div class="peer">
						<h2 id="name2">peer2</h2>
						<select id="entry2" class="snmp" required></select>
					</div>
				</div>
				<footer>
					<input type="reset" value="cancel">
					<input type="submit" value="apply">
				</footer>
			</form>
		</section>
		
		<section class="dialog">
			<form id="dialog">
				<div class="main">
					<div class="peer">
						<h2 id="name1">peer1</h2>
						<select name="entry1" class="snmp" required></select>
					</div>
					<div class="peer">
						<h2 id="name2">peer2</h2>
						<select id="entry2" class="snmp" required></select>
					</div>
				</div>
				<footer>
					<input type="reset" value="cancel">
					<input type="submit" value="apply">
				</footer>
			</form>
		</section>
		
	<script src="../js/Draggable.js"></script>
	<script>

if (window === top) throw "";

var svgNS = "http://www.w3.org/2000/svg",
		xlinkNS = "http://www.w3.org/1999/xlink";

/**
 * stage
 */
(function (window, undefined) {
	var canvas = document.getElementById("stage"),
		base, translate, scale, ratio = 1,
		selectedDevice,
		deviceData = top.getDeviceData(),
		deviceMap = {},
		dragOrigin;

	function initialize() {		
		initEvent();
		
		resetStage();

		clearSelectionMark();

		for (var id in deviceData) {
			device = deviceData[id];
			
			svgDevice = document.createElementNS(svgNS, "image");
			
			deviceMap[id] = svgDevice;
			
			addDevice(svgDevice, device);
		}
		
		document.body.classList.remove("loading");
	}
	
	function initEvent() {
		var transformList = document.getElementById("transform").transform.baseVal;
		
		new Draggable(canvas);
			
		base = transformList.getItem(0);
		translate = transformList.getItem(1);
		drag = transformList.getItem(2);
		scale = transformList.getItem(3);

		window.addEventListener("resize", function (e) {
			resetStage();
		});
		
		canvas.addEventListener("selectstart", function (e) {
			e.preventDefault();
		});
		
		canvas.addEventListener("wheel", function (e) {
			if (e.deltaY < 0) {
				//확대
				ratio *= 1.1;
			}
			else {
				//축소
				ratio /= 1.1;
			}
			
			scale.setScale(ratio, ratio);
		});
		
		canvas.addEventListener("click", onClick);
		
		canvas.addEventListener("dragstart", function (e) {
			var data = e.detail,
				target = data.target;
			
			// drag 발생시 select 취소
			canvas.addEventListener("click", cancelClick);
			canvas.removeEventListener("click", onClick);
			
			if (target.tagName === "image") {
				dragOrigin = {
					x: Number(target.getAttributeNS(null, "x")),
					y: Number(target.getAttributeNS(null, "y"))
				};
			}
			else if (target.tagName === "circle") {
				dragOrigin = {
					x: Number(target.getAttributeNS(null, "cx")),
					y: Number(target.getAttributeNS(null, "cy"))
				};
			}
		});
		
		canvas.addEventListener("dragmove", function (e) {
			var data = e.detail,
				target = data.target;

			// selectedDevice 인 경우 moveDevice
			if (target === selectedDevice) {
				moveDevice(dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
				
				setSelectionMark();
			}
			// linkToken 인 경우 moveLinkToken
			else if (isLinkToken(target)){
				var destination = data.destination;
				
				if (destination !== target && destination.tagName === "image") {
					moveLinkToken(Number(destination.getAttributeNS(null, "x")), Number(destination.getAttributeNS(null, "y")));
				}
				else {
					moveLinkToken(dragOrigin.x + Math.round(data.dragX / ratio), dragOrigin.y + Math.round(data.dragY / ratio));
				}
			}
			// 그렇지 않은 모든 경우 moveStage
			else {
				drag.setTranslate(data.dragX, data.dragY);
			}
		});
		
		canvas.addEventListener("dragend", function (e) {
			var data = e.detail,
				target = data.target,
				destination = data.destination;
			
			if (target === selectedDevice) {
			}
			else if (isLinkToken(target)){
				if (destination.tagName === "image") {
					showDialog(deviceData[selectedDevice.getAttributeNS(null, "id")], deviceData[destination.getAttributeNS(null, "id")]);
				}
				
				setSelectionMark();
			}
			else {
				translate.setMatrix(translate.matrix.translate(drag.matrix.e, drag.matrix.f));
				drag.setTranslate(0, 0);
			}
		});
	}
	
	function onClick(e) {
		var target = e.target;
		
		selectedDevice = target.tagName === "image"? target: undefined;
		
		if (selectedDevice) {
			topDevice(selectedDevice);
			
			setSelectionMark();
		}
		else {
			clearSelectionMark();
		}
		
	}
	
	function cancelClick(e) {
		canvas.addEventListener("click", onClick);
		canvas.removeEventListener("click", cancelClick);
	}
	
	window.resetStage = function () {
		rect = canvas.getBoundingClientRect();
		
		base.setTranslate(rect.width /2, rect.height /2);
	};

	window.moveStage = function (x, y) {
		translate.setTranslate(- x, - y);
	};
	
	window.getSelectedDeviceID = function () {
		return selectedDevice.getAttributeNS(null, "id");
	};
	
	window.getSvgDevice = function (id) {
		return deviceMap[id];
	};
	
	window.getDevice = function (id) {
		return deviceData[id];
	};
	
	window.editDevice = function () {
		
	};
	
	window.initialize = initialize;
	
}) (window);

/**
 * device
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("device"),
		iconData = top.getIconData(),
		deviceMap = {},
		nameMap = {},
		svgDevice, svgName, device;

	function initialize() {
	}
	
	window.addDevice = function (svgDevice, device) {
		var id = device.id;
		
		svgDevice.setAttributeNS(null, "id", id);
		svgDevice.setAttributeNS(null, "x", device.x);
		svgDevice.setAttributeNS(null, "y", device.y);
		svgDevice.setAttributeNS(xlinkNS, "xlink:href", "../"+ iconData[device.type].src);
		svgDevice.setAttributeNS(null, "width", "40px");
		svgDevice.setAttributeNS(null, "height", "40px");
		svgDevice.setAttributeNS(null, "transform", "translate(-20, -20)");
		
		canvas.appendChild(svgDevice);
		
		svgName = document.createElementNS(svgNS, "text");
		
		svgName.textContent = device.name;
		svgName.setAttributeNS(null, "x", device.x);
		svgName.setAttributeNS(null, "y", device.y);
		svgName.setAttributeNS(null, "transform", "translate(0, 25)");
		
		nameMap[id] = svgName;
		
		canvas.appendChild(svgName);
		
		setLine(device);
	};
	
	window.moveDevice = function (x, y) {
		var id = getSelectedDeviceID(),
			svgDevice = getSvgDevice(id);
		
		svgName = nameMap[id];
		
		svgDevice.setAttributeNS(null, "x", x);
		svgDevice.setAttributeNS(null, "y", y);
		
		svgName.setAttributeNS(null, "x", x);
		svgName.setAttributeNS(null, "y", y);
		
		moveLine(id, x, y);
	};
	
	window.topDevice = function (svgDevice) {
		canvas.appendChild(svgDevice);
	};
	
	initialize();
	
}) (window);

/**
 * select
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("selection"),
		selectionMark = document.getElementById("selection_mark"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
	}
		
	window.setSelectionMark = function () {
		var id = getSelectedDeviceID(),
			device = getDevice(id),
			svgDevice = getSvgDevice(id),
			x = Number(svgDevice.getAttributeNS(null, "x")),
			y = Number(svgDevice.getAttributeNS(null, "y"));
		
		selectionMark.setAttributeNS(null, "cx", x);
		selectionMark.setAttributeNS(null, "cy", y);
		
		canvas.appendChild(selectionMark);
		
		showNavigation(x, y, device.snmp);
	};
	
	window.clearSelectionMark = function () {
		fragment.appendChild(selectionMark);
		
		hideNavigation();
	};
	
	initialize();
	
}) (window);

/**
 * navigation
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("navigation"),
		navigation = document.getElementById("tool"),
		linkToken = document.getElementById("link_token"),
		svgLink = document.getElementById("link_line"),
		chartAnchor = document.getElementById("chart_anchor"),
		editAnchor = document.getElementById("edit_anchor"),
		fragment = document.createDocumentFragment();
	
	function initialize() {
		chartAnchor.onclick = function (e) {
			e.stopPropagation();
			
			top.showChart(getSelectedDeviceID());
		};
		
		editAnchor.onclick = function (e) {
			e.stopPropagation();
			
			editDevice();
		};
	}
		
	window.showNavigation = function (x, y, chart) {
		svgLink.setAttributeNS(null, "x1", x);
		svgLink.setAttributeNS(null, "y1", y);
		svgLink.setAttributeNS(null, "x2", x);
		svgLink.setAttributeNS(null, "y2", y);
		
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y -32);
		
		chartAnchor.setAttributeNS(null, "x", x);
		chartAnchor.setAttributeNS(null, "y", y);
		
		editAnchor.setAttributeNS(null, "x", x);
		editAnchor.setAttributeNS(null, "y", y);
		
		canvas.classList[chart? "add": "remove"]("chart");
		
		canvas.appendChild(navigation);
	};
	
	window.isLinkToken = function (target) {
		return target === linkToken;
	};
	
	window.hideNavigation = function () {
		fragment.appendChild(navigation);
	};
	
	window.moveLinkToken = function (x, y) {
		linkToken.setAttributeNS(null, "cx", x);
		linkToken.setAttributeNS(null, "cy", y);
		
		svgLink.setAttributeNS(null, "x2", x);
		svgLink.setAttributeNS(null, "y2", y);
	};
	
	initialize();
	
}) (window);

/**
 * interface name
 */
(function (window, undefined) {
	var canvas = document.getElementById("if_name");
	
	window.createLabel = function (name, x1, y1, x2, y2) {
		var nameSvg = document.createElementNS(svgNS, "text");
		
		nameSvg.textContent = name;
		
		moveLabel(nameSvg, x1, y1, x2, y2);
		
		canvas.appendChild(nameSvg);
		
		return nameSvg;
	};
	
	window.moveLabel = function (nameSvg, x1, y1, x2, y2) {
		nameSvg.setAttributeNS(null, "x", (x1 *2 + x2) /3);
		nameSvg.setAttributeNS(null, "y", (y1 *2 + y2) /3);
	};
	
}) (window);

/**
 * line
 */
(function (window, undefined) {
	
	var canvas = document.getElementById("line"),
		lineMap = {};
	
	window.setLine = function (device) {
		var ifEntry = device.ifEntry,
			peerMap = {},
			peer, data, lineSvg,
			nameSvg = document.createElementNS(svgNS, "text");
		
		lineMap[device.id] = peerMap;
		
		for (var name in ifEntry) {
			peer = getDevice(ifEntry[name]);
			
			nameSvg = createLabel(name, device.x, device.y, peer.x, peer.y);
			
			data = lineMap[peer.id];
			
			if (data) {
				data = data[device.id];
				
				data.name2 = nameSvg;
			}
			else {
				lineSvg = document.createElementNS(svgNS, "line");
				
				lineSvg.setAttributeNS(null, "x1", device.x);
				lineSvg.setAttributeNS(null, "y1", device.y);
				lineSvg.setAttributeNS(null, "x2", peer.x);
				lineSvg.setAttributeNS(null, "y2", peer.y);
				
				data = {
					peer1: device.id,
					name1: nameSvg,
					peer2: peer.id,
					svg: canvas.appendChild(lineSvg)
				};
			}
			
			peerMap[peer.id] = data;
		}
	};
	
	window.moveLine = function (id, x, y) {
		var peerMap = lineMap[id],
			data, svgDevice,
			x1, y1, x2, y2;
		
		for (var peerID in peerMap) {
			data = peerMap[peerID];
			svgDevice = data.svg;
			
			if (data.peer1 === id) {
				svgDevice.setAttributeNS(null, "x1", x);
				svgDevice.setAttributeNS(null, "y1", y);
				
				x1 = x;
				y1 = y;
				x2 = Number(svgDevice.getAttributeNS(null, "x2"));
				y2 = Number(svgDevice.getAttributeNS(null, "y2"));
			}
			else {
				svgDevice.setAttributeNS(null, "x2", x);
				svgDevice.setAttributeNS(null, "y2", y);
				
				x1 = Number(svgDevice.getAttributeNS(null, "x1"));
				y1 = Number(svgDevice.getAttributeNS(null, "y1"));
				x2 = x;
				y2 = y;
			}
			
			moveLabel(data.name1, x1, y1, x2, y2);
			moveLabel(data.name2, x2, y2, x1, y1);
		}
	};
	
}) (window);

// functional
(function (window, undefined) {
	
	var maximize = document.getElementById("maximize"),
		minimize = document.getElementById("minimize");
	
	function initialize() {
		maximize.addEventListener("click", window.maximize);
		
		minimize.addEventListener("click", function () {
			document.body.classList.remove("maximized");
			
			top.maximizeMap(false);
		});
	}
	
	window.maximize = function () {console.log(1);
		top.maximizeMap(true);
		
		document.body.classList.add("maximized");
	};
	
	initialize();
	
}) (window);

// dialog
(function (window, undefined){
	var device1, device2, ifEntry1, ifEntry2,
		form = document.getElementById("link");
	
	function initialize() {
		form.addEventListener("submit", function (e) {
			ifEntry1[form.elements["entry1"].value] = device2.id;
			ifEntry2[form.elements["entry2"].value] = device1.id;
			
			form.reset();
		});
		
		form.addEventListener("reset", function (e) {
			document.body.classList.remove("dialog", "link");
		});
	}
	
	function initInterface(select, entry) {
		var option;
		
		for (var name in entry) {
			if (entry[name]) {
				continue;
			}
			
			option = document.createElement("option");
			option.text = name;
			
			select.add(option);
		}
		
		select.value = "";
	}
	
	window.showDialog = function (peer1, peer2) {
		device1 = peer1;
		device2 = peer2;
		ifEntry1 = device1.ifEntry;
		ifEntry2 = device2.ifEntry;
		
		initInterface(form.elements["entry1"], ifEntry1);
		initInterface(form.elements["entry2"], ifEntry2);
		
		document.body.classList.add("dialog", "link");
		
		maximize();
	}
	
	initialize();
	
}) (window);

// public
function selectDevice(id) {
	var svgDevice = getSvgDevice(id);
	
	x = Number(svgDevice.getAttributeNS(null, "x"));
	y = Number(svgDevice.getAttributeNS(null, "y"));
	
	moveStage(x, y);
}

initialize();

	</script>

	</body>
</html>