<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM::Map</title>
		<link rel="stylesheet" href ="frame.css ">
		<style>
#toolbar {
	background-color: #ddd;
}

#toolbar.minimized #minimize {
	display: none;
}

#container {
	position: fixed; top: 10px; right: 10px; bottom: 10px; left: 10px;
}
		</style>
	
		<script src="js/Draggable.js"></script>
		<script src="js/Canvas.js"></script>
			
	</head>
	
	<body>
		<div id="container"></div>
		<script>	

(function (window, top) {
	
	if (window === top) {
		throw "";
	}
	
	var elements = {
			container: document.getElementById("container")
		},
		canvas = new Canvas(elements.container),
		layer = {
			device: canvas.add()
		},
		deviceList = top.getDeviceList(),
		iconMap = top.getIconMap();
	
	canvas.ondraw = function (context, hitContext, data) {
		var icon = iconMap[data.type],
			width = icon.width,
			height = icon.height,
			x = data.x,
			y = data.y;
		
		if (x === undefined || y === undefined) {
			return;
		}
		
		x -= Math.round(width /2);
		y -= Math.round(height /2);
		
		context.drawImage(icon, x, y, width, height);
		//context.fillText(device.name, x, y)
		
		hitContext.fillRect(x, y, width, height);
	};
	
	canvas.onenter = function (node) {
	};
	
	canvas.onleave = function (node) {
	};
	
	canvas.ondragstart = function (e) {
	};
	
	canvas.ondragmove = function (e) {
		if (e.node) {
			e.node.data.x += e.moveX;
			e.node.data.y += e.moveY;
			
			e.node.layer.invalidate();
			
			canvas.invalidate();
		}
		else {
			canvas.translate(e.dragX, e.dragY);
		}
	};

	canvas.ondragend = function (e) {
		if (e.node) {
			return;
		}
		else {
			moveMap(e.dragX, e.dragY);
			
			layer.device.invalidate();
			
			canvas.invalidate();
		}
	};
	
	(function () {
		for (var id in deviceList) {
			layer.device.add(deviceList[id]);
		}
		
		layer.device.invalidate();
		
		canvas.invalidate();
	}) ();
	
	elements.container.addEventListener("mousedown", onSelect, false);
	
	function onSelect() {
		var node = canvas.node;
		
		if (node) {
			node.layer.top(node);
		}
	}
	
	function moveMap(x, y) {
		var device;
		
		for (var id in deviceList) {
			device = deviceList[id];
			
			device.x += x;
			device.y += y;
		}
	}
	
	/**
	 * public method
	 */
	 
	window.selectDevice = function (id) {
		var device = deviceList[id];
		
		moveMap(-device.x, -device.y);
		
		layer.device.invalidate();
		
		canvas.invalidate();
	};
	
}) (window, top);

		</script>
	
	</body>
	
</html>