<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title>ITAhM::Map</title>
		<link rel="stylesheet" href ="frame.css ">
		<style>
#toolbar {
	background-color: #ddd;
}

#toolbar.minimized #minimize {
	display: none;
}

#container {
	position: fixed; top: 10px; right: 10px; bottom: 10px; left: 10px;
}
		</style>
	
		<script src="js/Draggable.js"></script>
		<script src="js/Canvas.js"></script>
			
	</head>
	
	<body>
		<div id="container"></div>
		<script>

var elements = {
		container: document.getElementById("container")
	};
	

(function (window, root) {
	
	var canvas = new Canvas(elements.container),
		layer = {
			device: canvas.add()
		},
		deviceMap,
		iconMap;
	
	canvas.ondraw = function (context, hitContext, data) {
		var icon = iconMap[data.type],
			width = icon.width,
			height = icon.height,
			x = data.x,
			y = data.y;
		
		if (x === undefined || y === undefined) {
			return;
		}
		
		x -= Math.round(width /2);
		y -= Math.round(height /2);
		
		context.drawImage(icon, x, y, width, height);
		//context.fillText(device.name, x, y)
		
		hitContext.fillRect(x, y, width, height);
	}
	
	canvas.onenter = function (node) {
	}
	
	canvas.onleave = function (node) {
	}
	
	function onSelect() {
		var node = canvas.node;
		
		if (node) {
			node.layer.top(node);
		}
	}
	
	canvas.ondragstart = function (e) {
	}
	
	canvas.ondragmove = function (e) {
		if (e.node) {
			e.node.data.x += e.moveX;
			e.node.data.y += e.moveY;
			
			e.node.layer.invalidate();
			
			canvas.invalidate();
		}
		else {
			canvas.translate(e.dragX, e.dragY);
		}
	}

	canvas.ondragend = function (e) {
		if (e.node) {
			return;
		}
		else {
			var data;
			
			for (var id in deviceMap) {
				data = deviceMap[id];
				
				data.x += e.dragX;
				data.y += e.dragY;
			}
			
			layer.device.invalidate();
			
			canvas.invalidate();
		}
	}
	
	elements.container.addEventListener("mousedown", onSelect, false);
	
	var thread = new Worker("worker/loader.js");
	
	thread.onmessage = function (e) {
		var data = e.data;
		
		loadIcon(data.icon, function (map) {
			iconMap = map;
			
			loadDevice();
		});
	}
	
	function loadDevice() {
		deviceMap = top.getDeviceList();
		
		for (var id in deviceMap) {
			layer.device.add(deviceMap[id]);
		}
		
		layer.device.invalidate();
		
		canvas.invalidate();
	}
	
	function loadIcon(iconMap, complete) {
		var names = Object.keys(iconMap),
			length = names.length,
			icon = new Image(),
			index = 0,
			map = {};
		
		icon.onload = onLoad;
		icon.src = iconMap[names[index]].src;
		
		function onLoad() {
			map[names[index]] = this;
			
			if (++index < length) {
				icon = new Image();
				icon.onload = onLoad;
				icon.src = iconMap[names[index]].src;
			}
			else {
				complete(map);
			}
		}
	}
	
	
}) (window, top);
		</script>
	
	</body>
	
</html>