<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
		<meta http-equiv="Content-Style-Type" content="text/css">
		<title></title>
		
		<style>
body,
h1 {
	font-family: tahoma, arial, "맑은 고딕"; 
}

iframe {
	width: 100%; height: 100%;
	margin: 0;
	padding: 0;
	border: 0;
}

.iframe {
	position: fixed; width: 50%; height: 50%;
}

body.maximized .iframe {
	width: 100%;
	height: 100%;
}

.iframe.tl {
	top: 0; left: 0;
}

.iframe.tr {
	top: 0; right: 0;
}

.iframe.bl {
	bottom: 0; left: 0;
}

.iframe.br {
	bottom: 0; right: 0;
}

#toolbar {
	position: absolute; top: 0; right: 0;
}

#toolbar img {
	vertical-align: middle;
	border: 1px solid transparent;
}

#toolbar img:hover {
	border-color: #ddf;
	cursor: pointer;
}

body.maximized #maximize,
body:not(.maximized) #minimize,
.hide {
	display: none;
}

		</style>
		
	</head>
	
	<body>
	
		<div class="iframe tl">
			<iframe id="frame_list"></iframe>
		</div>
		<div class="iframe tr">
			<iframe id="frame_map"></iframe>
		</div>
		<div class="iframe bl">
			<iframe id="frame_device"></iframe>
		</div>
		<div class="iframe br">
			<iframe id="frame_event"></iframe> 
		</div>
		
		<div class="hide">
			<div id="toolbar" class="minimized">
				<img id="maximize" src="img/maximize.png">
				<img id="minimize" src="img/minimize.png">
			</div>
		</div>
		
		<script>

(function (window, undefined){
	
	var elements = {
			toolbar: document.getElementById("toolbar"),
			maximize: document.getElementById("maximize"),
			minimize: document.getElementById("minimize"),
			frame: {
				list: document.getElementById("frame_list"),
				map : document.getElementById("frame_map"),
				device: document.getElementById("frame_device"),
				event: document.getElementById("frame_event")
			}
		},
		loader = new Worker("worker/loader.js"),
		deviceList, iconList,
		iconMap, typeMap,
		tmpID = 1;
	
	loader.onmessage = function (e) {
		deviceList = e.data.device;
		iconList = e.data.icon;
		
		loadIcon(function (map) {
			iconMap = map;
			
			/**
			 * icon 모두 load 된 후 페이지 시작
			 */
			load();
		});
	}
	
	/**
	 * 페이지 시작점
	 */
	function load() {
		var data, group;
		
		typeMap = {};
		
		for (var type in iconList) {
			data = iconList[type];
			group = data.group;
			
			if (!(group in typeMap)) {
				typeMap[group] = [];
			}
			
			typeMap[group].push(type);
		}
		
		elements.maximize.addEventListener("click", onMaximized, false);
		
		elements.minimize.addEventListener("click", onMinimized, false);
		
		(function (frame) {
			for (var id in frame) {
				frame[id].addEventListener("mouseenter", onFocus, false);
			}
			
		}) (elements.frame);
		
		elements.frame.list.src = "list.html";
		elements.frame.map.src = "map.html";
		elements.frame.device.src = "device.html";
		elements.frame.event.src = "event.html";
	}
	
	function onMaximized(e) {
		maximize(this.parentNode.parentNode);
	}
	
	function onMinimized(e) {
		minimize();
	}
	
	function onFocus() {
		var selected = this.parentNode;
		
		selected.appendChild(elements.toolbar);
	}
	
	function maximize(frame) {
		for (var id in elements.frame) {
			elements.frame[id].parentNode.classList.add("hide");
		}
		
		frame.classList.remove("hide");
		
		document.body.classList.add("maximized");
	}
	
	function minimize() {
		var frame = elements.frame;
		
		for (var id in frame) {
			frame[id].parentNode.classList.remove("hide");
		}
		
		document.body.classList.remove("maximized");
	}
	
	function loadIcon(complete) {
		var names = Object.keys(iconList),
			length = names.length,
			icon = new Image(),
			index = 0,
			map = {};
		
		icon.onload = onLoad;
		icon.src = iconList[names[index]].src;
		
		function onLoad() {
			map[names[index]] = this;
			
			if (++index < length) {
				icon = new Image();
				icon.onload = onLoad;
				icon.src = iconList[names[index]].src;
			}
			else {
				complete(map);
			}
		}
	}
	
	window.getDeviceList = function () {
		return deviceList;
	};
	
	window.getDevice = function (id) {
		return deviceList[id];
	};
	
	window.getIconData = function (type) {
		return iconList[type];
	};
	
	window.selectDevice = function (id) {
		if (document.body.classList.contains("maximized")) {
			minimize();
		}

		if (id) {
			elements.frame.map.contentWindow.selectDevice(id);
		}
		
		elements.frame.device.contentWindow.resetDevice(id);
	};
	
	window.getIconMap = function () {
		return iconMap;
	};
	
	window.getTypeMap = function () {
		return typeMap;
	};
	
	window.removeDevice = function (id) {
		console.log("remove >> "+ id);
	};
	
	window.createDeviceID = function () {
		return "-"+ tmpID++;
	};
	
	window.resetDevice = function (id) {
		elements.frame.list.contentWindow.document.location.reload();
		elements.frame.map.contentWindow.document.location.reload();
		elements.frame.device.contentWindow.resetDevice(id);
	};
	
}) (window);

		</script>
	
	</body>
	
</html>